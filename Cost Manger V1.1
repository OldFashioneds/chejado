<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A. Isaacs Batch Cost Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; }
        .tab-btn { padding: 10px 20px; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .tab-btn:hover { color: #1f2937; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        .hidden { display: none !important; }
        
        /* Kanban */
        .kanban-container { display: flex; gap: 16px; padding-bottom: 20px; overflow-x: auto; height: 100%; align-items: flex-start; }
        .kanban-col { background: #f9fafb; border-radius: 8px; padding: 12px; border: 1px solid #e5e7eb; display: flex; flex-direction: column; width: 280px; min-width: 280px; flex-shrink: 0; max-height: 100%; }
        #inbox-col { position: sticky; left: 0; z-index: 30; background: #eff6ff; border-color: #3b82f6; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        #inbox-col .kanban-header { background: #dbeafe; color: #1e40af; border-bottom-color: #bfdbfe; }
        .kanban-header { padding: 8px 0 12px 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 8px; flex-shrink: 0; position: relative; cursor: help; }
        .col-body { flex-grow: 1; overflow-y: auto; min-height: 100px; padding-right: 4px; }
        .col-body::-webkit-scrollbar { width: 6px; }
        .col-body::-webkit-scrollbar-track { background: transparent; }
        .col-body::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        /* Item Card */
        .item-card { background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid transparent; position: relative; transition: transform 0.1s; }
        .item-card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); z-index: 10; }
        .item-card:active { cursor: grabbing; }
        .item-card.Materials { border-left-color: #10b981; } 
        .item-card.Consumables { border-left-color: #f59e0b; } 
        .item-card.Equipment { border-left-color: #3b82f6; } 
        .item-card.Overhead { border-left-color: #6b7280; }
        .card-title { font-weight: 600; font-size: 0.8rem; color: #1f2937; line-height: 1.2; padding-right: 24px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
        .card-cost { font-size: 0.75rem; color: #6b7280; font-family: monospace; margin-top: 4px; }
        .bom-id-badge { font-size: 9px; background: #f3f4f6; color: #6b7280; padding: 1px 4px; border-radius: 3px; font-family: monospace; border: 1px solid #e5e7eb; margin-left: auto; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-delete-btn { border: none; background: transparent; color: #9ca3af; font-size: 12px; margin-left: 4px; cursor: pointer; padding: 0; }
        .item-delete-btn:hover { color: #dc2626; }

        /* Buttons */
        .apply-btn { font-size: 10px; background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 4px; cursor: pointer; flex-grow: 1; text-align: center; font-weight: bold; border: 1px solid #bae6fd; transition: all 0.2s; }
        .apply-btn:hover { background: #0ea5e9; color: white; border-color: #0ea5e9; }
        .suggest-btn { font-size: 10px; background: #f0fdf4; color: #15803d; padding: 4px 8px; border-radius: 4px; cursor: pointer; text-align: center; font-weight: bold; border: 1px solid #bbf7d0; transition: all 0.2s; }
        .suggest-btn:hover { background: #22c55e; color: white; border-color: #22c55e; }
        .header-actions { display: flex; gap: 4px; margin-bottom: 8px; }
        
        .add-rate-btn { position: absolute; top: 32px; right: 8px; width: 20px; height: 20px; border-radius: 4px; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid #e5e7eb; opacity: 0; transition: opacity 0.2s; }
        .item-card:hover .add-rate-btn { opacity: 1; }
        .add-rate-btn:hover { background: #2563eb; color: white; border-color: #2563eb; }

        /* Tooltip */
        .tooltip { visibility: hidden; opacity: 0; position: absolute; top: 100%; left: 0; background: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; width: 240px; z-index: 50; transition: opacity 0.2s; pointer-events: none; margin-top: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); white-space: normal; line-height: 1.4; }
        .group:hover .tooltip { visibility: visible; opacity: 1; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { text-align: left; padding: 10px; background: #f9fafb; font-weight: 600; color: #4b5563; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; }
        .data-table td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        .editable-cell { border: 1px solid transparent; padding: 4px; border-radius: 4px; width: 100%; background: transparent; }
        .editable-cell:focus { border-color: #2563eb; background: white; outline: none; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="bg-white border-b border-gray-200 px-6 py-4 flex-none">
        <div class="max-w-full mx-auto flex justify-between items-end">
            <div>
                <h1 class="text-xl font-bold text-gray-900">A. Isaacs Batch Cost Manager</h1>
                <p class="text-xs text-gray-500 mt-1">Allocated Architecture v1.6.0</p>
            </div>
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <div id="tab-sim" class="tab-btn rounded-md" onclick="switchTab('sim')">Dashboard</div>
                <div id="tab-mgr" class="tab-btn active rounded-md bg-white text-blue-700 shadow-sm" onclick="switchTab('mgr')">Allocation</div>
                <div id="tab-matrix" class="tab-btn rounded-md" onclick="switchTab('matrix')">Matrix</div>
                <div id="tab-rates" class="tab-btn rounded-md" onclick="switchTab('rates')">Rate Card</div>
                <div id="tab-rules" class="tab-btn rounded-md" onclick="switchTab('rules')">Rules</div>
                <div id="tab-jobaid" class="tab-btn rounded-md" onclick="switchTab('jobaid')">Job Aid</div>
                <div id="tab-batch" class="tab-btn rounded-md" onclick="switchTab('batch')">Function Tables</div>
            </div>
            <button type="button" onclick="downloadAppSource()" class="ml-3 bg-gray-100 border border-gray-300 text-xs font-bold px-3 py-1 rounded hover:bg-gray-200" title="Download this app as an HTML file">‚¨á Export Code</button>
        </div>
    </div>

    <div class="flex-grow overflow-hidden relative">
        <!-- TAB 1: SIMULATOR -->
        <div id="view-sim" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card bg-blue-50 border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase">Unit Cost (COGS)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1" id="total_cogs">$0.00</p>
                    </div>
                    <div class="card">
                        <p class="text-xs font-bold text-gray-500 uppercase">Target MSRP</p>
                        <div class="flex items-center mt-2"><span class="text-2xl font-bold text-gray-400 mr-1">$</span><input type="number" id="msrp_input" class="text-3xl font-bold bg-transparent border-b border-gray-300 w-32 focus:outline-none" value="35.00" oninput="updateSim()"></div>
                    </div>
                    <div class="card" id="margin_card">
                        <p class="text-xs font-bold text-gray-500 uppercase">Gross Margin</p>
                        <p class="text-3xl font-bold mt-1" id="margin_val">0.0%</p>
                        <p class="text-xs font-bold mt-1" id="margin_status">--</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="font-bold text-gray-800 text-sm">Global Variables</h3>
                                <select id="process_param_set_selector" class="text-xs border rounded px-2 py-1 bg-white" onchange="applyProcessParameterSet(this.value)">
                                    <option value="">-- Manual --</option>
                                </select>
                            </div>
                            <div id="preset_indicator" class="text-xs text-gray-500 mb-2 hidden"></div>
                            <div id="preset_actions" class="mb-3 hidden">
                                <button type="button" onclick="applyParameterSetToRateCard()" class="text-[10px] bg-amber-100 border border-amber-300 text-amber-700 px-2 py-1 rounded hover:bg-amber-200">Apply to Rate Card</button>
                            </div>
                            <div class="mb-4"><div class="flex justify-between text-xs font-bold text-gray-600 mb-1"><span>Founder Labor</span><span id="labor_val" class="text-blue-600">$0/hr</span></div><input type="range" id="labor_rate_slider" min="0" max="100" step="5" value="0" class="w-full accent-blue-600" oninput="updateSim()"></div>
                            <div class="mb-4"><div class="flex justify-between text-xs font-bold text-gray-600 mb-1"><span>Touch Time</span><span id="time_val" class="text-blue-600">82 min</span></div><input type="range" id="time_slider" min="45" max="120" step="1" value="82" class="w-full accent-blue-600" oninput="updateSim()"></div>
                            <div><div class="flex justify-between text-xs font-bold text-gray-600 mb-1"><span>Monthly Volume</span><span id="vol_val" class="text-blue-600">96 Units</span></div><input type="range" id="vol_slider" min="8" max="200" step="8" value="96" class="w-full accent-blue-600" oninput="updateSim()"></div>
                        </div>
                        <div class="card bg-gray-50 border border-gray-200">
                            <ul class="text-sm space-y-2" id="cost_breakdown_list"></ul>
                            <div class="border-t mt-3 pt-2">
                                <div class="text-xs font-bold text-gray-500 mb-1">Overhead by Pool</div>
                                <ul class="text-xs space-y-1" id="overhead_pool_breakdown_list"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 card flex items-center justify-center"><div class="w-3/4 h-64"><canvas id="costChart"></canvas></div></div>
                </div>
                
                <!-- Cost by Function Table -->
                <div class="card mt-6">
                    <h3 class="font-bold text-gray-800 mb-2 text-sm border-b pb-2">Cost by Function (per unit)</h3>
                    <p class="text-xs text-gray-500 mb-3">Shows how COGS breaks down by functional area (F0‚ÄìF10). Costs flow from Rate Card ‚Üí Usage ‚Üí Allocations.</p>
                    <div class="overflow-x-auto">
                        <table class="data-table text-xs">
                            <thead>
                                <tr>
                                    <th>Func</th>
                                    <th>Scope</th>
                                    <th class="text-right">$ / Unit</th>
                                    <th>Contributing BOM IDs</th>
                                </tr>
                            </thead>
                            <tbody id="function-cost-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: ALLOCATION MANAGER -->
        <div id="view-mgr" class="h-full flex flex-col">
            <div class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center flex-none">
                <div class="flex items-center gap-4 w-2/3">
                    <div class="relative w-64">
                        <input type="file" id="csv_upload" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="bg-blue-50 border border-blue-200 text-blue-700 text-xs font-bold py-2 px-4 rounded flex items-center justify-center gap-2 hover:bg-blue-100 transition"><span>üìÑ Load BOM CSV</span></div>
                    </div>
                    <!-- GitHub import button -->
                    <button id="github_bom_btn" type="button" onclick="loadBOMFromGitHub()" class="bg-purple-50 border border-purple-200 text-purple-700 text-xs font-bold py-2 px-4 rounded flex items-center justify-center gap-2 hover:bg-purple-100 transition">üåê Load BOM from GitHub</button>
                    <button type="button" onclick="openGithubBomConfig()" class="text-[11px] text-purple-600 border border-purple-200 px-2 py-1 rounded hover:bg-purple-50 ml-1">‚öô</button>
                </div>
                <div class="flex gap-2 w-full justify-end">
                    <input type="text" id="new_bomId" placeholder="BOM ID" class="border rounded text-xs px-2 py-1 w-20 font-mono" title="Leave blank to auto-generate">
                    <input type="text" id="new_name" placeholder="Manual Item" class="border rounded text-xs px-2 py-1 w-32">
                    <input type="number" id="new_cost" placeholder="$" class="border rounded text-xs px-2 py-1 w-16">
                    <button onclick="addNewItem()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded transition">Add</button>
                </div>
            </div>

            <div class="flex-grow overflow-hidden p-4 bg-gray-50">
                <div class="kanban-container" id="kanban-container">
                    <div class="kanban-col" id="inbox-col">
                        <div class="kanban-header flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold uppercase tracking-wider">Inbox</span>
                                <button type="button" class="text-[9px] text-red-500 border border-red-200 px-1.5 py-0.5 rounded hover:bg-red-50" onclick="clearInbox()">Clear</button>
                            </div>
                            <span class="text-[10px] font-mono bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full" id="total-Unallocated">$0</span>
                        </div>
                        <div id="list-Unallocated" class="col-body space-y-2" data-func="Unallocated"></div>
                    </div>
                    <div id="func-cols-container" class="flex gap-4 h-full"></div>
                </div>
            </div>
        </div>

        <!-- TAB 3: RATE CARD -->
        <div id="view-rates" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Equipment Rental Rates -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">Equipment Rental Rates</h3>
                            <p class="text-xs text-gray-500 mt-1">Set "Usage" to specify machine minutes per finished unit</p>
                        </div>
                        <button onclick="openRateModal('machine')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100">+ Add</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>BOM ID</th>
                                    <th class="text-right cursor-help" title="Derived from Purchase Cost and Useful Life. This is the machine's cost per hour, independent of unit volume.">Hourly Rate ‚ìò</th>
                                    <th>Life (yrs)</th>
                                    <th class="text-right">Capacity (hrs)</th>
                                    <th class="text-center bg-blue-50 cursor-help" title="How many minutes this asset is used to produce one finished unit. Changing this will change the unit COGS, not the hourly rate.">Usage (min/unit) ‚ìò</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-machines"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Material Unit Rates -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">Material Unit Rates</h3>
                            <p class="text-xs text-gray-500 mt-1">Set "Usage" to specify quantity consumed per finished unit</p>
                        </div>
                        <button onclick="openRateModal('material')" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded hover:bg-green-100">+ Add</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>BOM ID</th>
                                    <th class="text-right">Unit Rate</th>
                                    <th>Bulk Cost</th>
                                    <th>Quantity</th>
                                    <th class="text-center bg-green-50">Usage (units/unit)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-materials"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Consumable Unit Rates -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">Consumable Unit Rates</h3>
                            <p class="text-xs text-gray-500 mt-1">Set "Usage" to specify quantity consumed per finished unit</p>
                        </div>
                        <button onclick="openRateModal('consumable')" class="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded hover:bg-orange-100">+ Add</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Consumable</th>
                                    <th>BOM ID</th>
                                    <th class="text-right">Unit Rate</th>
                                    <th>Bulk Cost</th>
                                    <th>Quantity</th>
                                    <th class="text-center bg-orange-50">Usage (units/unit)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-consumables"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Overhead Rates -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">Overhead Rates</h3>
                            <p class="text-xs text-gray-500 mt-1">Monthly fixed costs spread across production volume</p>
                        </div>
                        <button onclick="openRateModal('overhead')" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">+ Add</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Overhead Item</th>
                                    <th>BOM ID</th>
                                    <th>Pool</th>
                                    <th class="text-right">Monthly Cost</th>
                                    <th class="text-right bg-gray-100">Per Unit</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-overhead"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Overhead Pools -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800">Overhead Pools</h3>
                            <p class="text-xs text-gray-500 mt-1">Groups monthly overhead into named pools for clearer reporting.</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table text-xs">
                            <thead>
                                <tr>
                                    <th>Pool</th>
                                    <th>Description</th>
                                    <th class="text-center">Active</th>
                                    <th class="text-right">Monthly $ (from items)</th>
                                    <th class="text-right">$/Unit (at current volume)</th>
                                </tr>
                            </thead>
                            <tbody id="overhead-pools-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: RULES -->
        <div id="view-rules" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-6xl mx-auto card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-900">Allocation Strategy & Rules</h2>
                    <div class="relative">
                        <input type="file" id="rules_upload" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <button class="text-xs bg-gray-100 text-gray-700 px-3 py-2 rounded font-bold hover:bg-gray-200 border border-gray-300">‚¨ÜÔ∏è Load Rules (CSV)</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table"><thead><tr><th class="w-16">ID</th><th class="w-48">Function Name</th><th>Key Rule</th><th>Keywords (Editable)</th></tr></thead><tbody id="rules-table-body"></tbody></table>
                </div>
            </div>
        </div>

        <!-- TAB 5: MATRIX (Requirements Verification Matrix) -->
        <div id="view-matrix" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-full mx-auto card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">Allocation Rule Matrix</h2>
                        <p class="text-xs text-gray-500 mt-1">
                            Click any cell to toggle a rule for that item. Rows show items with at least one rule.
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <span class="text-xs text-gray-500">Items with rules:</span>
                            <span id="matrix-count" class="ml-1 font-bold text-blue-600">0</span>
                        </div>
                        <button onclick="exportMatrixCSV()" class="text-xs bg-gray-100 px-3 py-1.5 rounded border hover:bg-gray-200 font-medium">
                            ‚¨áÔ∏è Export CSV
                        </button>
                        <div class="relative">
                            <input type="file" id="matrix_upload" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <button class="text-xs bg-gray-100 px-3 py-1.5 rounded border hover:bg-gray-200 font-medium">
                                ‚¨ÜÔ∏è Import CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr id="matrix-head-row"></tr>
                        </thead>
                        <tbody id="matrix-body"></tbody>
                    </table>
                </div>
                <div id="matrix-empty" class="hidden text-center py-12 text-gray-400">
                    <p class="text-lg">No items have rules appended yet.</p>
                    <p class="text-sm mt-2">Drag items to functional columns, then click "‚ûï Allocate Part" to record allocations.</p>
                </div>
            </div>
        </div>

        <!-- TAB 6: JOB AID -->
        <div id="view-jobaid" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-5xl mx-auto space-y-6">
                
                <!-- COST TYPE DEFINITIONS -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">Cost Type Definitions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 class="text-sm font-bold text-blue-600 mb-2">Equipment (CAPEX)</h3>
                            <p class="text-xs text-gray-600 mb-2 italic">Durable assets. Life > 1 year.</p>
                            <p class="text-xs"><strong>Allocation:</strong> Hourly Rate</p>
                            <p class="text-xs text-gray-500 mt-1">CNC, Laser, Steamer, 3D Printer</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                            <h3 class="text-sm font-bold text-orange-500 mb-2">Consumables (OPEX)</h3>
                            <p class="text-xs text-gray-600 mb-2 italic">Items used up in production.</p>
                            <p class="text-xs"><strong>Direct:</strong> Per gram/unit</p>
                            <p class="text-xs"><strong>Indirect:</strong> Overhead %</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                            <h3 class="text-sm font-bold text-green-600 mb-2">Materials (Direct)</h3>
                            <p class="text-xs text-gray-600 mb-2 italic">Raw inputs ‚Üí product.</p>
                            <p class="text-xs"><strong>Allocation:</strong> Unit Rate</p>
                            <p class="text-xs text-gray-500 mt-1">Lumber, Dowels, Hardware</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-sm font-bold text-gray-600 mb-2">Overhead (Fixed)</h3>
                            <p class="text-xs text-gray-600 mb-2 italic">"Cost of Existence"</p>
                            <p class="text-xs"><strong>Allocation:</strong> Monthly √∑ Volume</p>
                            <p class="text-xs text-gray-500 mt-1">Rent, Benches, Software</p>
                        </div>
                    </div>
                </div>

                <!-- CORE PRINCIPLE -->
                <div class="card bg-indigo-50 border border-indigo-200">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">üéØ</div>
                        <div>
                            <h3 class="font-bold text-indigo-800">Core Principle: Process-Based Allocation</h3>
                            <p class="text-sm text-indigo-700">An item belongs to the function where it <strong>creates value</strong> or is <strong>consumed</strong>.</p>
                        </div>
                    </div>
                </div>

                <!-- FUNCTIONAL ALLOCATION GUIDE -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">WSP Functional Allocation Guide</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <!-- F0 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F0</span>
                                <h3 class="font-bold text-gray-800">Raw Material Procurement</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Gateway</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Any cost incurred <strong>before</strong> the material enters your shop.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Raw Lumber:</strong> Air-Dried Walnut, Exotic Woods</p>
                                <p><strong>Logistics:</strong> Vehicle Mileage, Transport Bins</p>
                                <p><strong>Access:</strong> Makerspace Membership, Sign-off fees</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F0">You bought it to get the wood</span>
                            </div>
                        </div>

                        <!-- F1 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F1</span>
                                <h3 class="font-bold text-gray-800">Infrastructure</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Foundation</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Assets that stay in the shop and support <strong>multiple</strong> functions. "The Landlord's" assets.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Furniture:</strong> Workbenches, rolling carts, storage racks, bins</p>
                                <p><strong>Environment:</strong> Vacuums, dust collectors, lights, fans, air filters</p>
                                <p><strong>Safety:</strong> Fire blankets, first aid, cameras</p>
                                <p><strong>Digital:</strong> Computers, monitors, software (CAD/CAM)</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F1">It stays in the room when the batch leaves</span>
                            </div>
                        </div>

                        <!-- F2 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F2</span>
                                <h3 class="font-bold text-gray-800">Material Prep</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Cut</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Transforming raw stock (F0) into specific parts (Ribs, Keystones).</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Active Machines:</strong> Laser Engraver, CNC Machine, Drill Press</p>
                                <p><strong>Tooling:</strong> Drill bits, CNC end mills, Laser lenses</p>
                                <p><strong>Direct Materials:</strong> Wood stock as it is being consumed</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F2">It cuts, drills, or marks the wood</span>
                            </div>
                        </div>

                        <!-- F3 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F3</span>
                                <h3 class="font-bold text-gray-800">Soak</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Wet Work</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Preparing the wood with moisture.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Equipment:</strong> Electric Kettle, Water Distiller</p>
                                <p><strong>Consumables:</strong> Distilled Water</p>
                                <p><strong>Tooling:</strong> Soaking vessels/jars</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F3">It involves water or moisture conditioning</span>
                            </div>
                        </div>

                        <!-- F4 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F4</span>
                                <h3 class="font-bold text-gray-800">Steam</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Heat</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Applying high heat to soften lignin.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Equipment:</strong> Electric Steamer</p>
                                <p><strong>Tooling:</strong> Tongs, heat gloves (if specific to this step)</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F4">It makes steam or handles hot wood</span>
                            </div>
                        </div>

                        <!-- F5 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F5</span>
                                <h3 class="font-bold text-gray-800">Shaping</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Bend</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Constraining the wood into its final form.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Tooling:</strong> 3D Printed Molds/Forms, specific clamps</p>
                                <p><strong>Equipment:</strong> 3D Printer (makes tooling for this step)</p>
                                <p><strong>Consumables:</strong> Filament (used to print forms)</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F5">It forces the wood into a curve</span>
                            </div>
                        </div>

                        <!-- F6 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F6</span>
                                <h3 class="font-bold text-gray-800">Inspection</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Check</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Verifying quality before finishing.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Metrology:</strong> Calipers, Moisture Meters, Gage Blocks</p>
                                <p><strong>Tools:</strong> Inspection Lights, Granite Surface Plate</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F6">It measures or verifies</span>
                            </div>
                        </div>

                        <!-- F7 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F7</span>
                                <h3 class="font-bold text-gray-800">Finishing</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Shine</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Applying the protective coating.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Consumables:</strong> Shellac Flakes, Isopropyl Alcohol, Sandpaper, Rags</p>
                                <p><strong>Tooling:</strong> Tumbler (mixing), Jars, Brushes, Dipping hooks</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F7">It is sticky, liquid, or abrasive</span>
                            </div>
                        </div>

                        <!-- F8 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F8</span>
                                <h3 class="font-bold text-gray-800">Assembly</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Build</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Putting the parts together.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Consumables:</strong> Glue/Adhesive, Rubber bands, Eyelet screws, Hang tags</p>
                                <p><strong>Tooling:</strong> Assembly jigs</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F8">It bonds parts or adds hardware</span>
                            </div>
                        </div>

                        <!-- F9 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F9</span>
                                <h3 class="font-bold text-gray-800">QC Final</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Proof</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Validating the finished product.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Tooling:</strong> Hang test fixtures, Drop test pads</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F9">It tests the final product</span>
                            </div>
                        </div>

                        <!-- F10 -->
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition md:col-span-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">F10</span>
                                <h3 class="font-bold text-gray-800">Documentation</h3>
                                <span class="text-gray-400 text-xs ml-auto">The Record</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-3 italic">Managing the data and business side.</p>
                            <div class="bg-gray-50 rounded p-3 text-xs space-y-1">
                                <p><strong>Consumables:</strong> Labels, Printer paper, Ink</p>
                                <p><strong>Tools:</strong> Label maker, Office supplies</p>
                            </div>
                            <div class="mt-3 bg-blue-50 border-l-4 border-blue-500 p-2 text-xs text-blue-800">
                                <strong>Key Rule:</strong> <span id="keyrule-F10">It tracks, labels, or records</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- QUICK DECISION TREE -->
                <div class="card bg-amber-50 border border-amber-200">
                    <h3 class="font-bold text-amber-800 mb-4 flex items-center gap-2">
                        <span class="text-xl">ü§î</span> Quick Decision Tree
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F0">"You bought it to get the wood?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F0 Procurement</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F1">"It stays in the room when the batch leaves?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F1 Infrastructure</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F2">"It cuts, drills, or marks the wood?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F2 Material Prep</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F3">"It involves water or moisture conditioning?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F3 Soak</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F4">"It makes steam or handles hot wood?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F4 Steam</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F5">"It forces the wood into a curve?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F5 Shaping</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F6">"It measures or verifies?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F6 Inspection</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F7">"It is sticky, liquid, or abrasive?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F7 Finishing</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F8">"It bonds parts or adds hardware?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F8 Assembly</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100">
                            <p class="font-medium text-gray-700" id="dt-F9">"It tests the final product?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F9 QC Final</p>
                        </div>
                        <div class="bg-white rounded p-3 border border-amber-100 md:col-span-2">
                            <p class="font-medium text-gray-700" id="dt-F10">"It tracks, labels, or records?"</p>
                            <p class="text-amber-700 font-bold">‚Üí F10 Documentation</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- TAB 7: FUNCTION DATA BROWSER -->
        <div id="view-batch" class="h-full overflow-y-auto p-6 hidden">
            <div class="max-w-6xl mx-auto" id="function-data-root">
                <!-- Function selector -->
                <div class="flex items-center gap-3 mb-4">
                    <label class="text-xs font-bold text-gray-600">Functional Area:</label>
                    <select id="function_filter_selector" class="border rounded px-3 py-1.5 text-xs" onchange="onFunctionFilterChange(this.value)">
                        <option value="ALL">All Functions</option>
                    </select>
                    <span class="text-[10px] text-gray-400" id="function_filter_meta"></span>
                </div>

                <!-- BOM Allocation Card -->
                <div class="card mb-4">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="font-bold text-gray-800 text-sm">BOM Allocation</h3>
                        <span class="text-[10px] text-gray-500" id="bom_alloc_meta"></span>
                    </div>
                    <div id="bom_alloc_table_container"></div>
                </div>

                <!-- Parameter Schema Card -->
                <div class="card mb-4">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">Parameter Schema (v1.7)</h3>
                            <span class="text-[10px] text-gray-400" id="param_schema_status"></span>
                        </div>
                        <button type="button" class="text-[10px] px-2 py-1 rounded border text-gray-600 hover:bg-gray-100" onclick="loadParamSchemaFromGitHub()">üîÑ Reload from GitHub</button>
                    </div>
                    <div id="param_schema_table_container"></div>
                </div>

                <!-- Cost Allocation Card -->
                <div class="card">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm">Cost Allocation (v1.7)</h3>
                            <span class="text-[10px] text-gray-400" id="cost_alloc_status"></span>
                        </div>
                        <button type="button" class="text-[10px] px-2 py-1 rounded border text-gray-600 hover:bg-gray-100" onclick="loadCostAllocationFromGitHub()">üîÑ Reload from GitHub</button>
                    </div>
                    <div id="cost_alloc_table_container"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODALS & SCRIPTS -->
    <!-- KEYWORD MODAL -->
    <div id="keyword-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6">
            <h3 class="font-bold text-gray-900 mb-2 text-lg" id="keyword-modal-title">Suggested Keywords</h3>
            <p class="text-xs text-gray-500 mb-4">Words found in this column not yet in rules:</p>
            <div id="keyword-list" class="bg-gray-50 p-3 rounded border border-gray-200 max-h-48 overflow-y-auto mb-4 text-sm font-mono text-gray-700"></div>
            <div class="flex justify-end gap-2"><button onclick="closeKeywordModal()" class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-100 rounded">Cancel</button><button onclick="acceptKeywords()" class="px-4 py-2 text-sm font-bold text-white bg-green-600 hover:bg-green-700 rounded shadow-sm">Add Selected</button></div>
        </div>
    </div>

    <!-- RATE MODAL -->
    <div id="rate-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6">
            <h3 class="font-bold text-gray-900 mb-4 text-lg" id="modal-title">Add to Rate Card</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Item Name</label><input type="text" id="rm_name" class="w-full border rounded p-2 text-sm bg-gray-50"></div>
                <div><label id="rm_cost_label" class="block text-xs font-bold text-gray-500 mb-1">Purchase Cost</label><input type="number" id="rm_cost" class="w-full border rounded p-2 text-sm bg-gray-50"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">BOM ID <span class="text-red-500">*</span></label><input type="text" id="rm_bomId" class="w-full border rounded p-2 text-sm" placeholder="Required - links to BOM inventory"></div>
                <div id="rm_life_div" class="hidden"><label class="block text-xs font-bold text-blue-600 mb-1">Useful Life (Yrs)</label><input type="number" id="rm_life" class="w-full border border-blue-300 rounded p-2 text-sm" value="5"></div>
                <div id="rm_mat_div" class="hidden space-y-3">
                    <div><label class="block text-xs font-bold text-green-600 mb-1">Bulk Quantity</label><input type="number" id="rm_qty" class="w-full border border-green-300 rounded p-2 text-sm" placeholder="e.g. 216"></div>
                    <div><label class="block text-xs font-bold text-green-600 mb-1">Yield %</label><input type="number" id="rm_yield" class="w-full border border-green-300 rounded p-2 text-sm" value="100"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2"><button onclick="closeRateModal()" class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-100 rounded">Cancel</button><button onclick="saveRateItem()" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded shadow-sm">Save</button></div>
        </div>
    </div>

    <!-- GITHUB CONFIG MODAL -->
    <div id="github-modal" class="modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6">
            <h3 class="font-bold text-gray-900 mb-3 text-lg">Configure GitHub BOM URL</h3>
            <p class="text-xs text-gray-500 mb-3">Enter the raw CSV URL from GitHub (e.g., raw.githubusercontent.com/.../file.csv).</p>
            <input type="text" id="github_bom_url_input" class="w-full border rounded p-2 text-xs font-mono mb-4">
            <div class="flex justify-between items-center">
                <button type="button" class="px-3 py-1.5 text-xs text-gray-500 hover:bg-gray-100 rounded" onclick="resetGithubBomUrlToDefault()">Reset to Default</button>
                <div class="flex gap-2">
                    <button type="button" class="px-4 py-2 text-xs font-bold text-gray-500 hover:bg-gray-100 rounded" onclick="closeGithubBomConfig()">Cancel</button>
                    <button type="button" class="px-4 py-2 text-xs font-bold text-white bg-purple-600 hover:bg-purple-700 rounded shadow-sm" onclick="saveGithubBomConfig()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA MODEL ---
        let FUNCTIONAL_ARCHITECTURE = [
            { id: 'F0', name: 'Procurement', desc: 'Raw Material Procurement & Stock Conversion', ruleLabel: 'You bought it to get the wood', keywords: 'LUMBER,SOURCE,MAKERSPACE,TRANSPORT,MILEAGE,MEMBERSHIP,PLANK,WALNUT,MAPLE,EXOTIC,RAW,SIGN-OFF,F0' },
            { id: 'F1', name: 'Infrastructure', desc: 'Infrastructure & Resource Mgmt (Permanent Assets)', ruleLabel: 'It stays in the room when the batch leaves', keywords: 'WORKBENCH,VACUUM,LIGHT,SAFETY,STORAGE,RACK,CART,MONITOR,POWER,VENTILATION,FILTER,TOOLING,PRINTER,EMPORIA,SOFTWARE,RENT,EXTENSION,CORD,SHELF,CABINET,BIN,ORGANIZER,F1' },
            { id: 'F2', name: 'Material Prep', desc: 'Material Preparation (On-Site)', ruleLabel: 'It cuts, drills, or marks the wood', keywords: 'LASER,CNC,CUT,DRILL,KEYSTONE,INTERFACE,DOWEL,SHEET,PREP,SCULPFUN,CARVERA,TABLET,F2' },
            { id: 'F3', name: 'Soak', desc: 'Material Plasticization (Moisture)', ruleLabel: 'It involves water or moisture conditioning', keywords: 'SOAK,KETTLE,WATER,DISTILLED,MOISTURE,WET,CONDITION,VESSEL,F3' },
            { id: 'F4', name: 'Steam', desc: 'Thermal Plasticization (Heat)', ruleLabel: 'It makes steam or handles hot wood', keywords: 'STEAM,HEAT,THERMAL,TONGS,STEAMA,BUYDEEM,F4' },
            { id: 'F5', name: 'Shaping', desc: 'Shaping (Air Dry & Clamping)', ruleLabel: 'It forces the wood into a curve', keywords: 'CLAMP,FORM,MOLD,SHAPE,BEND,DRYING,SPRING-BACK,BLOCKING,F5' },
            { id: 'F6', name: 'Inspection', desc: 'Post-Shaping Inspection (QC Gate)', ruleLabel: 'It measures or verifies', keywords: 'INSPECT,CALIPER,MEASURE,CHECK,GAGE,VERIFY,QC,F6' },
            { id: 'F7', name: 'Finishing', desc: 'Surface Protection (Shellac)', ruleLabel: 'It is sticky, liquid, or abrasive', keywords: 'SHELLAC,FINISH,SAND,ALCOHOL,COAT,BRUSH,TUMBLER,JAR,FLAKES,RAGS,F7' },
            { id: 'F8', name: 'Assembly', desc: 'Assembly (Integration & Hardware)', ruleLabel: 'It bonds parts or adds hardware', keywords: 'ASSEMBLE,GLUE,BOND,HOOK,TAG,EYELET,RUBBER BAND,ADHESIVE,F8' },
            { id: 'F9', name: 'QC Final', desc: 'Final Validation (Proof)', ruleLabel: 'It tests the final product', keywords: 'TEST,HANG,DROP,PROOF,FINAL,INTEGRITY,F9' },
            { id: 'F10', name: 'Docs', desc: 'Documentation & Admin', ruleLabel: 'It tracks, labels, or records', keywords: 'LABEL,TRACEABILITY,ADMIN,LAPTOP,OFFICE,PAPER,BOOK,NOTEBOOK,F10' }
        ];

        let OVERHEAD_POOLS = [
            { id: 'POOL-GEN', label: 'General Overhead', desc: 'Catch-all pool for misc monthly costs.', isActive: true },
            { id: 'POOL-INFRA', label: 'Infrastructure', desc: 'Benches, storage, shop fixtures, etc.', isActive: true },
            { id: 'POOL-SOFT', label: 'Software & Digital', desc: 'CAD/CAM, subscriptions, online tools.', isActive: true }
        ];

        // Pre-defined parameter sets for production scenarios
        const PROCESS_PARAMETER_SETS = {
            "Baseline_V1": {
                label: "Baseline ‚Äì Variant 1",
                laborRatePerHour: 30,
                touchTimeMinutes: 82,
                monthlyVolumeUnits: 96,
                ribsPerOrnament: 8,
                avgLaserMinutesPerRib: 0.9,
                avgSteamMinutesPerRib: 1.2,
                avgShellacGramsPerRib: 0.6,
                sourceBatchId: "BATCH-001",
                variantId: "V1"
            },
            "Baseline_V2": {
                label: "Baseline ‚Äì Variant 2",
                laborRatePerHour: 30,
                touchTimeMinutes: 90,
                monthlyVolumeUnits: 80,
                ribsPerOrnament: 8,
                avgLaserMinutesPerRib: 1.1,
                avgSteamMinutesPerRib: 1.3,
                avgShellacGramsPerRib: 0.8,
                sourceBatchId: "BATCH-010",
                variantId: "V2"
            }
        };

        let inventory = [];
        let rateCard = { machines: [], materials: [], consumables: [], overhead: [] };
        
        // Function Data Browser state
        let selectedFunctionId = 'ALL';  // 'ALL', 'F0', 'F1', ... 'F10'
        let parameterSchemaRows = [];    // Loaded from GitHub CSV
        let costAllocationRows = [];     // Loaded from GitHub CSV
        
        // GitHub URLs for Function Data Browser CSVs
        const DEFAULT_PARAM_SCHEMA_URL = 'https://raw.githubusercontent.com/OldFashioneds/chejado/main/Parameter_Schema_v1_7.csv';
        const DEFAULT_COST_ALLOC_URL = 'https://raw.githubusercontent.com/OldFashioneds/chejado/main/Cost_Allocation_v1_7.csv';
        let paramSchemaUrl = DEFAULT_PARAM_SCHEMA_URL;
        let costAllocUrl = DEFAULT_COST_ALLOC_URL;
        
        // Load custom URLs from localStorage
        try {
            const savedParamUrl = localStorage.getItem('isaacs_param_schema_url');
            if (savedParamUrl) paramSchemaUrl = savedParamUrl;
            const savedCostUrl = localStorage.getItem('isaacs_cost_alloc_url');
            if (savedCostUrl) costAllocUrl = savedCostUrl;
        } catch(e) {}
        
        let currentProcessParamSetId = null;  // Currently selected parameter set
        let chartInstance = null;
        let currentKeywordTargetId = null;
        let currentModalType = null;

        // Try to load from localStorage (will fail silently in restricted environments)
        try {
            const saved = localStorage.getItem('isaacs_rates_v8');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Ensure arrays exist even if localStorage has partial data
                rateCard = {
                    machines: Array.isArray(parsed.machines) ? parsed.machines : [],
                    materials: Array.isArray(parsed.materials) ? parsed.materials : [],
                    consumables: Array.isArray(parsed.consumables) ? parsed.consumables : [],
                    overhead: Array.isArray(parsed.overhead) ? parsed.overhead : []
                };
            }
        } catch(e) { console.log('localStorage not available'); }

        // Export app source as downloadable HTML file
        function downloadAppSource() {
            try {
                const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'A-Isaacs-Batch-Cost-Manager.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('Unable to export code from this environment.');
                console.error(e);
            }
        }


        // --- FUNCTION DATA BROWSER MODULE ---
        
        // Handle function filter change
        function onFunctionFilterChange(funcId) {
            selectedFunctionId = funcId || 'ALL';
            renderFunctionDataView();
        }
        
        // Populate function filter selector with F0-F10 options
        function populateFunctionFilterSelector() {
            const select = document.getElementById('function_filter_selector');
            if (!select) return;
            
            let html = '<option value="ALL">All Functions</option>';
            FUNCTIONAL_ARCHITECTURE.forEach(function(f) {
                html += '<option value="' + f.id + '">' + f.id + ' ‚Äì ' + f.name + '</option>';
            });
            select.innerHTML = html;
        }
        
        // Load Parameter Schema CSV from GitHub
        async function loadParamSchemaFromGitHub() {
            const statusEl = document.getElementById('param_schema_status');
            if (statusEl) statusEl.textContent = 'Loading...';
            
            try {
                const resp = await fetch(paramSchemaUrl, { cache: 'no-store' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const text = await resp.text();
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(result) {
                        parameterSchemaRows = Array.isArray(result.data) ? result.data : [];
                        if (statusEl) statusEl.textContent = 'Loaded ' + parameterSchemaRows.length + ' rows';
                        renderFunctionDataView();
                    },
                    error: function(err) {
                        console.error('[ParamSchema] Parse error:', err);
                        if (statusEl) statusEl.textContent = 'Parse error';
                    }
                });
            } catch (e) {
                console.error('[ParamSchema] Fetch error:', e);
                if (statusEl) statusEl.textContent = 'Fetch failed: ' + e.message;
            }
        }
        
        // Load Cost Allocation CSV from GitHub
        async function loadCostAllocationFromGitHub() {
            const statusEl = document.getElementById('cost_alloc_status');
            if (statusEl) statusEl.textContent = 'Loading...';
            
            try {
                const resp = await fetch(costAllocUrl, { cache: 'no-store' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const text = await resp.text();
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(result) {
                        costAllocationRows = Array.isArray(result.data) ? result.data : [];
                        if (statusEl) statusEl.textContent = 'Loaded ' + costAllocationRows.length + ' rows';
                        renderFunctionDataView();
                    },
                    error: function(err) {
                        console.error('[CostAlloc] Parse error:', err);
                        if (statusEl) statusEl.textContent = 'Parse error';
                    }
                });
            } catch (e) {
                console.error('[CostAlloc] Fetch error:', e);
                if (statusEl) statusEl.textContent = 'Fetch failed: ' + e.message;
            }
        }
        
        // Main render function for Function Data Browser
        function renderFunctionDataView() {
            populateFunctionFilterSelector();
            
            // Update meta info
            const metaEl = document.getElementById('function_filter_meta');
            if (metaEl) {
                if (selectedFunctionId === 'ALL') {
                    metaEl.textContent = '';
                } else {
                    const func = FUNCTIONAL_ARCHITECTURE.find(f => f.id === selectedFunctionId);
                    metaEl.textContent = func ? func.ruleLabel : '';
                }
            }
            
            renderBomAllocationTable();
            renderParamSchemaTable();
            renderCostAllocationTable();
        }
        
        // Render BOM Allocation table
        function renderBomAllocationTable() {
            const container = document.getElementById('bom_alloc_table_container');
            const metaEl = document.getElementById('bom_alloc_meta');
            if (!container) return;
            
            // Filter inventory by selected function
            let filteredItems = inventory;
            if (selectedFunctionId !== 'ALL') {
                filteredItems = inventory.filter(function(item) {
                    return item.func === selectedFunctionId || 
                           (Array.isArray(item.rules) && item.rules.includes(selectedFunctionId));
                });
            }
            
            if (metaEl) {
                metaEl.textContent = filteredItems.length + ' items';
            }
            
            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">No BOM items match the selected function. Load a BOM CSV first.</p>';
                return;
            }
            
            // Build table
            let html = '<div class="overflow-x-auto"><div class="max-h-72 overflow-y-auto">';
            html += '<table class="data-table text-xs w-full">';
            html += '<thead class="sticky top-0 bg-white"><tr>';
            html += '<th>BOM ID</th>';
            html += '<th>Part Name</th>';
            html += '<th class="text-right">Cost</th>';
            html += '<th>Cost Type</th>';
            html += '<th>Primary Func</th>';
            html += '<th>Appended Functions</th>';
            html += '<th>In Rate Card?</th>';
            html += '</tr></thead><tbody>';
            
            filteredItems.forEach(function(item) {
                // Check which Rate Card buckets contain this BOM ID
                const inMachines = (rateCard.machines || []).some(r => String(r.bomId) === String(item.bomId));
                const inMaterials = (rateCard.materials || []).some(r => String(r.bomId) === String(item.bomId));
                const inConsumables = (rateCard.consumables || []).some(r => String(r.bomId) === String(item.bomId));
                const inOverhead = (rateCard.overhead || []).some(r => String(r.bomId) === String(item.bomId));
                
                let rateCardTags = [];
                if (inMachines) rateCardTags.push('<span class="bg-blue-100 text-blue-700 px-1 rounded">M</span>');
                if (inMaterials) rateCardTags.push('<span class="bg-green-100 text-green-700 px-1 rounded">Mat</span>');
                if (inConsumables) rateCardTags.push('<span class="bg-orange-100 text-orange-700 px-1 rounded">C</span>');
                if (inOverhead) rateCardTags.push('<span class="bg-gray-100 text-gray-700 px-1 rounded">OH</span>');
                
                const rateCardStatus = rateCardTags.length > 0 ? rateCardTags.join(' ') : '<span class="text-gray-300">‚Äì</span>';
                const appendedFuncs = Array.isArray(item.rules) && item.rules.length > 0 ? item.rules.join(', ') : '‚Äì';
                
                html += '<tr>';
                html += '<td class="font-mono">' + (item.bomId || '‚Äì') + '</td>';
                html += '<td>' + (item.name || '‚Äì') + '</td>';
                html += '<td class="text-right font-mono">$' + (parseFloat(item.cost) || 0).toFixed(2) + '</td>';
                html += '<td>' + (item.visualType || '‚Äì') + '</td>';
                html += '<td class="font-mono">' + (item.func || '‚Äì') + '</td>';
                html += '<td class="font-mono text-[10px]">' + appendedFuncs + '</td>';
                html += '<td>' + rateCardStatus + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // Render Parameter Schema table
        function renderParamSchemaTable() {
            const container = document.getElementById('param_schema_table_container');
            if (!container) return;
            
            if (parameterSchemaRows.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">No parameter schema loaded. Click "Reload from GitHub" to fetch.</p>';
                return;
            }
            
            // Filter by Function_ID
            let filteredRows = parameterSchemaRows;
            if (selectedFunctionId !== 'ALL') {
                filteredRows = parameterSchemaRows.filter(function(row) {
                    return row['Function_ID'] === selectedFunctionId;
                });
            }
            
            if (filteredRows.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">No parameters for ' + selectedFunctionId + '.</p>';
                return;
            }
            
            // Derive columns from first row (dynamic)
            const allKeys = Object.keys(filteredRows[0] || {});
            // Prioritize certain columns, then include others
            const priorityKeys = ['Function_ID', 'Parameter_ID', 'Parameter_Name', 'Description', 'Units', 'Data_Type'];
            const orderedKeys = priorityKeys.filter(k => allKeys.includes(k));
            allKeys.forEach(k => { if (!orderedKeys.includes(k)) orderedKeys.push(k); });
            
            // Build table
            let html = '<div class="overflow-x-auto"><div class="max-h-72 overflow-y-auto">';
            html += '<table class="data-table text-xs w-full">';
            html += '<thead class="sticky top-0 bg-white"><tr>';
            orderedKeys.forEach(function(key) {
                html += '<th>' + key + '</th>';
            });
            html += '</tr></thead><tbody>';
            
            filteredRows.forEach(function(row) {
                html += '<tr>';
                orderedKeys.forEach(function(key) {
                    const val = row[key] != null ? row[key] : '';
                    html += '<td>' + val + '</td>';
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // Render Cost Allocation table
        function renderCostAllocationTable() {
            const container = document.getElementById('cost_alloc_table_container');
            if (!container) return;
            
            if (costAllocationRows.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">No cost allocation data loaded. Click "Reload from GitHub" to fetch.</p>';
                return;
            }
            
            // Filter by Function_ID
            let filteredRows = costAllocationRows;
            if (selectedFunctionId !== 'ALL') {
                filteredRows = costAllocationRows.filter(function(row) {
                    return row['Function_ID'] === selectedFunctionId;
                });
            }
            
            if (filteredRows.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">No cost allocations for ' + selectedFunctionId + '.</p>';
                return;
            }
            
            // Derive columns from first row (dynamic)
            const allKeys = Object.keys(filteredRows[0] || {});
            // Prioritize certain columns
            const priorityKeys = ['Function_ID', 'BOM_ID', 'ExpenseType', 'Cost Category', 'Direct or Overhead'];
            const orderedKeys = priorityKeys.filter(k => allKeys.includes(k));
            allKeys.forEach(k => { if (!orderedKeys.includes(k)) orderedKeys.push(k); });
            
            // Add Status column at the end
            orderedKeys.push('_Status');
            
            // Build table
            let html = '<div class="overflow-x-auto"><div class="max-h-72 overflow-y-auto">';
            html += '<table class="data-table text-xs w-full">';
            html += '<thead class="sticky top-0 bg-white"><tr>';
            orderedKeys.forEach(function(key) {
                if (key === '_Status') {
                    html += '<th>Status</th>';
                } else {
                    html += '<th>' + key + '</th>';
                }
            });
            html += '</tr></thead><tbody>';
            
            filteredRows.forEach(function(row) {
                // Check if BOM_ID exists in inventory
                const bomId = row['BOM_ID'];
                const existsInInventory = bomId && inventory.some(item => String(item.bomId) === String(bomId));
                
                html += '<tr>';
                orderedKeys.forEach(function(key) {
                    if (key === '_Status') {
                        if (!bomId) {
                            html += '<td class="text-gray-400">‚Äì</td>';
                        } else if (existsInInventory) {
                            html += '<td class="text-green-600 font-bold">OK</td>';
                        } else {
                            html += '<td class="text-red-500 font-bold">Missing</td>';
                        }
                    } else {
                        const val = row[key] != null ? row[key] : '';
                        html += '<td>' + val + '</td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }
        
        // --- PROCESS PARAMETER SET FUNCTIONS ---
        
        // Populate the parameter set selector dropdown
        function populateProcessParamSelector() {
            const select = document.getElementById('process_param_set_selector');
            if (!select) return;
            
            let html = '<option value="">-- Manual --</option>';
            Object.keys(PROCESS_PARAMETER_SETS).forEach(function(setId) {
                const config = PROCESS_PARAMETER_SETS[setId];
                const label = config.label || setId;
                html += '<option value="' + setId + '">' + label + '</option>';
            });
            select.innerHTML = html;
        }
        
        // Apply a pre-defined parameter set to the Dashboard sliders
        function applyProcessParameterSet(paramSetId) {
            currentProcessParamSetId = paramSetId || null;
            const indicator = document.getElementById('preset_indicator');
            const actions = document.getElementById('preset_actions');
            
            if (!paramSetId || !PROCESS_PARAMETER_SETS[paramSetId]) {
                // Manual mode - hide indicator and actions
                if (indicator) {
                    indicator.classList.add('hidden');
                    indicator.innerHTML = '';
                }
                if (actions) {
                    actions.classList.add('hidden');
                }
                return;
            }
            
            const config = PROCESS_PARAMETER_SETS[paramSetId];
            
            // Apply to sliders (only if fields exist)
            if (config.laborRatePerHour != null) {
                const laborSlider = document.getElementById('labor_rate_slider');
                if (laborSlider) laborSlider.value = config.laborRatePerHour;
            }
            
            if (config.touchTimeMinutes != null) {
                const timeSlider = document.getElementById('time_slider');
                if (timeSlider) timeSlider.value = config.touchTimeMinutes;
            }
            
            if (config.monthlyVolumeUnits != null) {
                const volSlider = document.getElementById('vol_slider');
                if (volSlider) volSlider.value = config.monthlyVolumeUnits;
            }
            
            // Show indicator
            if (indicator) {
                let indicatorText = 'Preset: ' + (config.label || paramSetId);
                if (config.sourceBatchId) {
                    indicatorText += ' <span class="text-gray-400">(' + config.sourceBatchId + ')</span>';
                }
                indicator.innerHTML = indicatorText;
                indicator.classList.remove('hidden');
            }
            
            // Show actions
            if (actions) {
                actions.classList.remove('hidden');
            }
            
            // Update simulator with new values
            updateSim();
        }
        
        // Apply parameter set averages to Rate Card usage fields
        function applyParameterSetToRateCard() {
            if (!currentProcessParamSetId || !PROCESS_PARAMETER_SETS[currentProcessParamSetId]) {
                alert('Select a parameter set first from the Dashboard.');
                return;
            }
            
            const config = PROCESS_PARAMETER_SETS[currentProcessParamSetId];
            const ribsPerOrnament = config.ribsPerOrnament || 8;
            
            // Calculate per-unit (per-ornament) metrics from parameter set averages
            const laserMinPerUnit = (config.avgLaserMinutesPerRib || 0) * ribsPerOrnament;
            const steamMinPerUnit = (config.avgSteamMinutesPerRib || 0) * ribsPerOrnament;
            const shellacGramsPerUnit = (config.avgShellacGramsPerRib || 0) * ribsPerOrnament;
            
            const messages = [];
            const updates = [];
            
            // Find and update Laser machine
            const laserRow = (rateCard.machines || []).find(function(m) {
                return m.name && (m.name.toUpperCase().includes('LASER') || 
                                  m.name.toUpperCase().includes('SCULPFUN') || 
                                  m.name.toUpperCase().includes('CNC'));
            });
            if (laserRow) {
                laserRow.minutesPerUnit = laserMinPerUnit;
                updates.push('Laser minutes/unit: ' + laserMinPerUnit.toFixed(2));
            } else {
                messages.push('Could not find a Laser machine in Rate Card.');
            }
            
            // Find and update Steamer machine
            const steamRow = (rateCard.machines || []).find(function(m) {
                return m.name && (m.name.toUpperCase().includes('STEAM') || 
                                  m.name.toUpperCase().includes('BUYDEEM'));
            });
            if (steamRow) {
                steamRow.minutesPerUnit = steamMinPerUnit;
                updates.push('Steam minutes/unit: ' + steamMinPerUnit.toFixed(2));
            } else {
                messages.push('Could not find a Steamer machine in Rate Card.');
            }
            
            // Find and update Shellac consumable
            const shellacRow = (rateCard.consumables || []).find(function(m) {
                return m.name && m.name.toUpperCase().includes('SHELLAC');
            });
            if (shellacRow) {
                shellacRow.unitsPerUnit = shellacGramsPerUnit;
                updates.push('Shellac grams/unit: ' + shellacGramsPerUnit.toFixed(2));
            } else {
                messages.push('Could not find a Shellac consumable in Rate Card.');
            }
            
            // Persist changes
            if (updates.length > 0) {
                try {
                    localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard));
                } catch(e) {}
                
                renderRateTables();
                updateSim();
            }
            
            // Show feedback
            let feedbackMsg = '';
            if (updates.length > 0) {
                feedbackMsg = 'Updated Rate Card from preset "' + (config.label || currentProcessParamSetId) + '":\n‚Ä¢ ' + updates.join('\n‚Ä¢ ');
            }
            if (messages.length > 0) {
                if (feedbackMsg) feedbackMsg += '\n\n';
                feedbackMsg += 'Warnings:\n‚Ä¢ ' + messages.join('\n‚Ä¢ ');
            }
            
            if (feedbackMsg) {
                alert(feedbackMsg);
            } else {
                alert('No Rate Card entries could be updated. Add Laser, Steamer, or Shellac entries first.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initColumns(); populateRulesTab(); setupCSVUpload(); setupRulesUpload(); setupMatrixUpload(); populateFunctionFilterSelector(); populateProcessParamSelector(); initChart(); renderRateTables(); updateSim(); renderJobAidFromRules(); switchTab('sim');
            // Run duplicate check on load for diagnostics
            checkForDuplicateBomIds();
        });
        
        // --- BOM ID UNIQUENESS HELPERS ---
        
        // Generate a unique MAN-### BOM ID
        function generateUniqueBomId() {
            const existingManIds = inventory
                .map(i => String(i.bomId))
                .filter(id => id.startsWith('MAN-'))
                .map(id => {
                    const num = parseInt(id.replace('MAN-', ''), 10);
                    return isNaN(num) ? 0 : num;
                });
            
            let nextNum = 1;
            if (existingManIds.length > 0) {
                nextNum = Math.max(...existingManIds) + 1;
            }
            
            // Format with leading zeros (MAN-001, MAN-002, etc.)
            return 'MAN-' + String(nextNum).padStart(3, '0');
        }
        
        // Check if a BOM ID exists in inventory (case-insensitive for non-empty)
        function bomIdExists(bomId) {
            if (!bomId || bomId.trim() === '') return false;
            const normalizedId = String(bomId).trim();
            return inventory.some(i => String(i.bomId).trim() === normalizedId);
        }
        
        // Find item by BOM ID
        function findItemByBomId(bomId) {
            if (!bomId || bomId.trim() === '') return null;
            const normalizedId = String(bomId).trim();
            return inventory.find(i => String(i.bomId).trim() === normalizedId);
        }
        
        // Diagnostic: check for duplicate BOM IDs and warn
        function checkForDuplicateBomIds() {
            const bomIdCounts = {};
            inventory.forEach((item, idx) => {
                const bomId = String(item.bomId || '').trim();
                if (bomId === '') return; // Skip empty BOM IDs
                if (!bomIdCounts[bomId]) {
                    bomIdCounts[bomId] = [];
                }
                bomIdCounts[bomId].push({ index: idx, name: item.name });
            });
            
            // Log warnings for duplicates
            Object.entries(bomIdCounts).forEach(([bomId, items]) => {
                if (items.length > 1) {
                    console.warn('[BOM ID Integrity] Duplicate BOM ID "' + bomId + '" found ' + items.length + ' times:', 
                        items.map(i => '#' + i.index + ': "' + i.name + '"').join(', '));
                }
            });
        }
        
        // --- CASCADE DELETE HELPERS ---
        
        // Remove all Rate Card entries matching a BOM ID
        function cascadeDeleteByBomId(bomId) {
            if (!bomId) return;
            const normalized = String(bomId).trim();
            
            ['machines', 'materials', 'consumables', 'overhead'].forEach(type => {
                if (!Array.isArray(rateCard[type])) return;
                rateCard[type] = rateCard[type].filter(r => String(r.bomId || '').trim() !== normalized);
            });
            
            try {
                localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard));
            } catch (e) {
                console.log('Could not save updated rateCard to localStorage:', e);
            }
        }
        
        // Delete a single inventory item with cascade
        function deleteInventoryItem(itemId) {
            const idx = inventory.findIndex(i => i.id == itemId);
            if (idx === -1) return;
            
            const item = inventory[idx];
            const bomId = item.bomId || '';
            
            const message = 'Delete "' + item.name + '" (BOM ID: ' + bomId + ')? This will also remove any associated Rate Card rows and cost from the simulator.';
            if (!confirm(message)) return;
            
            // Remove from inventory
            inventory.splice(idx, 1);
            
            // Cascade delete by BOM ID
            cascadeDeleteByBomId(bomId);
            
            // Re-render everything that depends on inventory / rateCard
            renderBoard();
            renderMatrixView();
            renderRateTables();
            updateSim();
        }
        
        // Clear all Inbox items with cascade
        function clearInbox() {
            const inboxItems = inventory.filter(i => i.func === 'Unallocated');
            if (!inboxItems.length) return;
            
            const msg = 'Delete ' + inboxItems.length + ' item(s) from Inbox and remove them from all cost calculations?';
            if (!confirm(msg)) return;
            
            const bomIdsToDelete = new Set(
                inboxItems
                    .map(i => String(i.bomId || '').trim())
                    .filter(Boolean)
            );
            
            // Remove inbox items from inventory
            inventory = inventory.filter(i => i.func !== 'Unallocated');
            
            // Cascade delete any rateCard rows for those BOM IDs
            bomIdsToDelete.forEach(cascadeDeleteByBomId);
            
            renderBoard();
            renderMatrixView();
            renderRateTables();
            updateSim();
        }

        // --- INBOX MATH FIX ---
        function renderBoard() {
            document.querySelectorAll('.col-body').forEach(el => el.innerHTML = '');
            let totals = { 'Unallocated': 0 }; FUNCTIONAL_ARCHITECTURE.forEach(f => totals[f.id]=0);
            let inboxTotal = 0;

            inventory.forEach(item => {
                let con = document.getElementById('list-' + item.func) || document.getElementById('list-Unallocated');
                if(con) {
                    // CRITICAL MATH FIX: Ensure Cost is Float
                    let c = parseFloat(item.cost) || 0;
                    
                    // Summation logic
                    if(item.func === 'Unallocated') {
                        inboxTotal += c;
                    } else {
                        totals[item.func] += c;
                    }
                    
                    // Button Logic - show + button for all cost types except if no bomId
                    let btn = '';
                    if(item.bomId && (item.visualType === 'Equipment' || item.visualType === 'Materials' || item.visualType === 'Consumables' || item.visualType === 'Overhead')) {
                         let safeName = item.name.replace(/["']/g, "");
                         let type = item.visualType === 'Equipment' ? 'machine' 
                                  : item.visualType === 'Materials' ? 'material' 
                                  : item.visualType === 'Consumables' ? 'consumable'
                                  : 'overhead';
                         btn = '<div class="add-rate-btn" onclick="openRateModal(\'' + type + '\', \'' + safeName + '\', ' + item.cost + ', \'' + (item.bomId || '') + '\')">+</div>';
                    }

                    // Rule badges - CLICKABLE to un-append individual rules
                    let ruleBadges = '';
                    if (Array.isArray(item.rules) && item.rules.length > 0) {
                        ruleBadges = '<div class="flex flex-wrap gap-1 mt-1">' + item.rules.map(r => 
                            '<span class="text-[8px] bg-green-100 text-green-700 px-1 rounded font-mono cursor-pointer hover:bg-red-100 hover:text-red-700" onclick="event.stopPropagation(); unappendRuleForItem(' + item.id + ', \'' + r + '\')" title="Click to remove ' + r + '">' + r + ' ‚úï</span>'
                        ).join('') + '</div>';
                    }

                    let selectHtml = '<select class="text-[9px] bg-transparent border-none font-bold uppercase text-gray-400 focus:ring-0 cursor-pointer p-0" onchange="changeItemCategory(' + item.id + ', this.value)"><option value="Overhead" ' + (item.visualType==='Overhead'?'selected':'') + '>Overhead</option><option value="Equipment" ' + (item.visualType==='Equipment'?'selected':'') + '>Equipment</option><option value="Materials" ' + (item.visualType==='Materials'?'selected':'') + '>Materials</option><option value="Consumables" ' + (item.visualType==='Consumables'?'selected':'') + '>Consumable</option></select>';
                    
                    let card = document.createElement('div'); card.className = 'item-card ' + item.visualType; card.setAttribute('data-id', item.id); card.setAttribute('title', item.desc || item.name);
                    card.innerHTML = '<div class="card-header-row"><div class="card-title truncate">' + item.name + '</div><span class="bom-id-badge">#' + item.bomId + '</span><button type="button" class="item-delete-btn" onclick="event.stopPropagation(); deleteInventoryItem(' + item.id + ')">√ó</button></div>' + btn + '<div class="flex justify-between items-center mt-1"><div class="card-cost">$' + c.toFixed(2) + '</div>' + selectHtml + '</div>' + ruleBadges;
                    con.appendChild(card);
                }
            });
            
            // UPDATE TOTALS DISPLAY
            document.getElementById('total-Unallocated').innerText = '$'+inboxTotal.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});
            Object.keys(totals).forEach(k => { let el = document.getElementById('total-' + k); if(el) el.innerText = '$'+totals[k].toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0}); });
            initSortable();
        }
        
        // Un-append a specific rule from a specific item (from Allocation Manager badges)
        function unappendRuleForItem(itemId, fId) {
            const item = inventory.find(i => i.id == itemId);
            if (!item || !Array.isArray(item.rules)) return;
            
            item.rules = item.rules.filter(r => r !== fId);
            
            renderBoard();
            renderMatrixView();
            updateSim();  // Recompute COGS & function costs
        }

        // --- CATEGORY SWITCHER ---
        function changeItemCategory(itemId, newType) {
            let item = inventory.find(i => i.id == itemId);
            if(item) {
                const oldType = item.visualType;
                item.visualType = newType;
                item.type = newType;
                
                // Remove Rate Card entries from incompatible buckets
                if (item.bomId && oldType !== newType) {
                    removeIncompatibleRateCardEntries(item.bomId, newType);
                }
                
                renderBoard(); // Re-render to update color and totals if needed
            }
        }
        
        // Helper: Get the Rate Card bucket name for a cost type
        function getRateCardBucketForType(costType) {
            switch(costType) {
                case 'Equipment': return 'machines';
                case 'Materials': return 'materials';
                case 'Consumables': return 'consumables';
                case 'Overhead': return 'overhead';
                default: return null;
            }
        }
        
        // Remove Rate Card entries that don't match the item's new cost type
        function removeIncompatibleRateCardEntries(bomId, newCostType) {
            if (!bomId) return;
            const normalizedBomId = String(bomId).trim();
            const allowedBucket = getRateCardBucketForType(newCostType);
            let removed = false;
            
            // Remove from all buckets except the allowed one
            ['machines', 'materials', 'consumables', 'overhead'].forEach(bucket => {
                if (bucket === allowedBucket) return; // Keep entries in the correct bucket
                if (!Array.isArray(rateCard[bucket])) return;
                
                const before = rateCard[bucket].length;
                rateCard[bucket] = rateCard[bucket].filter(r => String(r.bomId || '').trim() !== normalizedBomId);
                if (rateCard[bucket].length < before) {
                    removed = true;
                    console.log('[Cost Type Change] Removed BOM ID ' + bomId + ' from rateCard.' + bucket);
                }
            });
            
            if (removed) {
                try { localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard)); } catch(e) {}
                renderRateTables();
                updateSim();
            }
        }

        // --- SMART KEYWORD SUGGESTION LOGIC ---
        function suggestKeywords(fId) {
            currentKeywordTargetId = fId;
            let itemsInCol = inventory.filter(i => i.func === fId);
            if (itemsInCol.length === 0) return alert('No items in column ' + fId + '. Drag items here manually first, then click \'Extract\' to learn from them.');

            let wordCount = {};
            const stopWords = new Set(['THE','AND','FOR','WITH','SET','PACK','BOX','KIT','OF','IN','A','AN','TO','IS','BY','ON','AT','OR','EACH','PCS','PC','OZ','ML','MM','INCH','FT']);

            itemsInCol.forEach(item => {
                let words = (item.name + " " + item.desc).toUpperCase().split(/[^A-Z0-9]+/);
                words.forEach(w => {
                    if(w.length > 3 && !stopWords.has(w) && isNaN(w)) {
                        wordCount[w] = (wordCount[w] || 0) + 1;
                    }
                });
            });

            let currentRule = FUNCTIONAL_ARCHITECTURE.find(f => f.id === fId);
            let existingKeys = new Set(currentRule.keywords.split(',').map(k => k.trim().toUpperCase()));
            
            let suggestions = Object.entries(wordCount)
                .sort((a,b) => b[1] - a[1])
                .filter(e => !existingKeys.has(e[0])) 
                .slice(0, 10) 
                .map(e => e[0]);

            if(suggestions.length > 0) {
                showKeywordModal(fId, suggestions);
            } else {
                alert('Analysis Complete for ' + fId + '.\n\nNo new significant keywords found. The items here are likely already covered by existing rules.');
            }
        }

        function showKeywordModal(fId, keywords) {
            document.getElementById('keyword-modal').classList.remove('hidden');
            document.getElementById('keyword-modal-title').innerText = 'Extract Keywords: ' + fId;
            const list = document.getElementById('keyword-list');
            list.innerHTML = keywords.map(k => '<label class="flex items-center space-x-2 mb-1"><input type="checkbox" class="keyword-checkbox accent-blue-600" value="' + k + '" checked><span>' + k + '</span></label>').join('');
        }

        function closeKeywordModal() { document.getElementById('keyword-modal').classList.add('hidden'); }

        function acceptKeywords() {
            const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            if(selected.length > 0 && currentKeywordTargetId) {
                let rule = FUNCTIONAL_ARCHITECTURE.find(f => f.id === currentKeywordTargetId);
                rule.keywords += ',' + selected.join(',');
                populateRulesTab(); alert('Added ' + selected.length + ' keywords to ' + currentKeywordTargetId + '.');
            }
            closeKeywordModal();
        }

        // --- APPEND RULE (replaces auto-move Apply Rules) ---
        function appendRuleForColumn(fId) {
            let appended = 0;

            inventory.forEach(item => {
                // Only act on items currently in this functional column
                if (item.func === fId) {
                    if (!Array.isArray(item.rules)) item.rules = [];
                    if (!item.rules.includes(fId)) {
                        item.rules.push(fId);
                        appended++;
                    }
                }
            });

            renderBoard();
            renderMatrixView();
            updateSim();  // Recompute COGS & function costs
            alert('Appended rule ' + fId + ' to ' + appended + ' line item(s).');
        }

        // --- GitHub BOM URL (Configurable) ---
        const DEFAULT_GITHUB_BOM_URL = 'https://raw.githubusercontent.com/OldFashioneds/chejado/main/BOM_Master_Parts_List.csv';
        let githubBomUrl;
        try {
            githubBomUrl = localStorage.getItem('isaacs_github_bom_url') || DEFAULT_GITHUB_BOM_URL;
        } catch (e) {
            githubBomUrl = DEFAULT_GITHUB_BOM_URL;
        }

        // --- FILE IO ---
        function setupCSVUpload() { document.getElementById('csv_upload').addEventListener('change', (e) => { Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: (r) => { processCSVData(r.data); switchTab('mgr'); }}); }); }
        function setupRulesUpload() { document.getElementById('rules_upload').addEventListener('change', (e) => { Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: (r) => { processRulesData(r.data); }}); }); }
        
        // Fetch BOM CSV from GitHub and import via processCSVData
        async function loadBOMFromGitHub() {
            try {
                console.log('[BOM] Fetching from GitHub:', githubBomUrl);

                const resp = await fetch(githubBomUrl, { cache: 'no-store' });
                if (!resp.ok) {
                    throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
                }

                const text = await resp.text();

                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (result) => {
                        try {
                            if (!Array.isArray(result.data)) {
                                throw new Error('Parsed CSV has no data array');
                            }

                            processCSVData(result.data);
                            // Keep the same behavior as local upload:
                            switchTab('mgr');
                        } catch (err) {
                            console.error('[BOM] Error in processCSVData:', err);
                            alert('BOM import failed while processing the GitHub data. See console for details.');
                        }
                    },
                    error: (err) => {
                        console.error('[BOM] PapaParse error for GitHub BOM:', err);
                        alert('Could not parse BOM CSV from GitHub. See console for details.');
                    }
                });
            } catch (err) {
                console.error('[BOM] Fetch error for GitHub BOM:', err);
                alert('Could not fetch BOM from GitHub.\n\nCheck your internet connection or try again later.');
            }
        }
        
        // GitHub BOM URL Config Modal Functions
        function openGithubBomConfig() {
            const input = document.getElementById('github_bom_url_input');
            if (input) {
                input.value = githubBomUrl || DEFAULT_GITHUB_BOM_URL;
            }
            document.getElementById('github-modal').classList.remove('hidden');
        }
        
        function closeGithubBomConfig() {
            document.getElementById('github-modal').classList.add('hidden');
        }
        
        function saveGithubBomConfig() {
            const input = document.getElementById('github_bom_url_input');
            if (!input) return;
            
            const url = input.value.trim();
            if (!url) {
                alert('Please enter a URL or click "Reset to Default".');
                return;
            }
            
            githubBomUrl = url;
            try {
                localStorage.setItem('isaacs_github_bom_url', githubBomUrl);
            } catch (e) {
                console.log('Could not save GitHub BOM URL to localStorage:', e);
            }
            
            closeGithubBomConfig();
        }
        
        function resetGithubBomUrlToDefault() {
            githubBomUrl = DEFAULT_GITHUB_BOM_URL;
            try {
                localStorage.removeItem('isaacs_github_bom_url');
            } catch (e) {
                console.log('Could not clear GitHub BOM URL from localStorage:', e);
            }
            
            const input = document.getElementById('github_bom_url_input');
            if (input) input.value = githubBomUrl;
        }
        
        function processRulesData(data) {
            let updates = 0;
            data.forEach(row => {
                let id = row['ID'];
                if(id && id.startsWith('F')) {
                    let idx = FUNCTIONAL_ARCHITECTURE.findIndex(f => f.id === id);
                    if(idx >= 0) {
                        // Preserve existing values if not in CSV
                        const existing = FUNCTIONAL_ARCHITECTURE[idx];
                        FUNCTIONAL_ARCHITECTURE[idx] = { 
                            id: id, 
                            name: row['Activity Scope'] || existing.name, 
                            desc: row['Rule Description (Editable)'] || existing.desc, 
                            keywords: row['Logic / Keywords (Editable)'] || existing.keywords,
                            ruleLabel: row['Key Rule'] || existing.ruleLabel
                        };
                        updates++;
                    } else {
                        // New rule entry
                        FUNCTIONAL_ARCHITECTURE.push({ 
                            id: id, 
                            name: row['Activity Scope'] || '', 
                            desc: row['Rule Description (Editable)'] || '', 
                            keywords: row['Logic / Keywords (Editable)'] || '',
                            ruleLabel: row['Key Rule'] || ''
                        });
                        updates++;
                    }
                }
            });
            populateRulesTab(); 
            initColumns(); 
            renderJobAidFromRules();
            alert('Updated ' + updates + ' Rules.');
        }

        // --- CSV IMPORT: Update-or-Insert by BOM ID ---
        function processCSVData(data) {
            let created = 0;
            let updated = 0;
            let skipped = 0;
            
            data.forEach(row => {
                // Parse cost
                let cost = parseFloat((row['Total Cost'] || row['Cost'] || '0').toString().replace(/[$,]/g, ''));
                if (isNaN(cost)) {
                    skipped++;
                    return;
                }
                
                let bomId = String(row['BOM ID Number'] || '').trim();
                let name = row['Part Name'] || 'Item';
                
                // Simple heuristic for Visual Type
                let t = name.toUpperCase();
                let vType = 'Overhead';
                if(t.includes('MATERIAL') || t.includes('WOOD')) vType = 'Materials';
                else if(t.includes('CONSUMABLE') || t.includes('SUPPLY')) vType = 'Consumables';
                else if(t.includes('EQUIPMENT') || t.includes('TOOL')) vType = 'Equipment';
                
                // Handle BOM ID: update existing or create new
                if (bomId) {
                    // Non-empty BOM ID: check if exists
                    const existingItem = findItemByBomId(bomId);
                    
                    if (existingItem) {
                        // UPDATE existing item
                        existingItem.name = name;
                        existingItem.cost = cost;
                        existingItem.type = vType;
                        existingItem.visualType = vType;
                        // Keep existing: func, allocatedTo, rules, id, desc
                        updated++;
                    } else {
                        // CREATE new item with this BOM ID
                        inventory.push({
                            id: Date.now() + Math.random(), 
                            bomId: bomId,
                            name: name, 
                            cost: cost, 
                            desc: '',
                            type: vType, 
                            visualType: vType, 
                            func: 'Unallocated',
                            allocatedTo: '',
                            rules: []
                        });
                        created++;
                    }
                } else {
                    // Empty BOM ID: generate a unique MAN-### ID
                    const newBomId = generateUniqueBomId();
                    inventory.push({
                        id: Date.now() + Math.random(), 
                        bomId: newBomId,
                        name: name, 
                        cost: cost, 
                        desc: '',
                        type: vType, 
                        visualType: vType, 
                        func: 'Unallocated',
                        allocatedTo: '',
                        rules: []
                    });
                    created++;
                }
            });
            
            renderBoard();
            checkForDuplicateBomIds(); // Run integrity check
            
            // Build summary message
            let msg = 'CSV Import Complete:\n';
            msg += '‚Ä¢ Created: ' + created + ' new item(s)\n';
            msg += '‚Ä¢ Updated: ' + updated + ' existing item(s)\n';
            if (skipped > 0) {
                msg += '‚Ä¢ Skipped: ' + skipped + ' row(s) with invalid cost';
            }
            alert(msg);
        }

        // --- UI RENDERERS ---
        function initColumns() {
            const container = document.getElementById('func-cols-container');
            container.innerHTML = '';
            FUNCTIONAL_ARCHITECTURE.forEach(f => {
                const col = document.createElement('div');
                col.className = 'kanban-col';
                col.innerHTML = '<div class="kanban-header group relative"><div class="header-actions"><div class="apply-btn" onclick="appendRuleForColumn(\'' + f.id + '\')">‚ûï Allocate Part</div><div class="suggest-btn" onclick="suggestKeywords(\'' + f.id + '\')" title="Extract Keywords">Extract</div></div><div><span class="col-title block">' + f.id + '</span><span class="text-xs text-gray-500 truncate block w-48">' + f.name + '</span></div><span class="col-total" id="total-' + f.id + '">$0</span><div class="tooltip"><div class="font-bold text-blue-200 mb-1">' + f.name + '</div><div class="text-yellow-200 text-[10px] mb-1">"' + f.ruleLabel + '"</div>' + f.desc + '</div></div><div id="list-' + f.id + '" class="col-body" data-func="' + f.id + '"></div>';
                container.appendChild(col);
            });
        }

        function initSortable() { document.querySelectorAll('.col-body').forEach(con => { new Sortable(con, { group: 'shared', animation: 150, ghostClass: 'bg-blue-100', onEnd: function(evt) { let item = inventory.find(i => i.id == evt.item.getAttribute('data-id')); if (item) { item.func = evt.to.getAttribute('data-func'); renderBoard(); } }}); }); }
        
        function openRateModal(type, name, cost, bomId) { 
            name = name || '';
            cost = cost || 0;
            bomId = bomId || '';
            currentModalType = type; 
            
            // Track if opened from a card (has bomId) vs from Rate tab (no bomId)
            const openedFromCard = !!bomId;
            
            // If opening from card with a BOM ID, check for existing rate in target bucket
            if (openedFromCard) {
                const bucket = type === 'machine' ? 'machines' 
                             : type === 'material' ? 'materials'
                             : type === 'consumable' ? 'consumables'
                             : type === 'overhead' ? 'overhead' : null;
                
                if (bucket && Array.isArray(rateCard[bucket])) {
                    const existing = rateCard[bucket].find(r => String(r.bomId || '').trim() === String(bomId).trim());
                    if (existing) {
                        alert('A Rate Card entry already exists for BOM ID "' + bomId + '" in this bucket.\n\nEdit the existing entry in the Rate Card tab instead.');
                        return;
                    }
                }
            }
            
            document.getElementById('rate-modal').classList.remove('hidden'); 
            document.getElementById('modal-title').innerText = 
                type === 'machine' ? 'Add Equipment Rental Rate' 
                : type === 'material' ? 'Add Material Unit Rate' 
                : type === 'overhead' ? 'Add Overhead Rate'
                : 'Add Consumable Unit Rate';
            
            document.getElementById('rm_name').value = name; 
            document.getElementById('rm_name').readOnly = openedFromCard;
            document.getElementById('rm_cost').value = cost; 
            document.getElementById('rm_cost').readOnly = openedFromCard;
            document.getElementById('rm_bomId').value = bomId || '';
            document.getElementById('rm_bomId').readOnly = openedFromCard; // Lock BOM ID when from card
            
            // Update cost label for overhead
            const costLabel = document.getElementById('rm_cost_label');
            if (costLabel) {
                costLabel.innerText = type === 'overhead' ? 'Monthly Cost ($)' : 'Purchase Cost';
            }
            
            if(type === 'machine') { 
                document.getElementById('rm_life_div').classList.remove('hidden'); 
                document.getElementById('rm_mat_div').classList.add('hidden'); 
            } else if (type === 'overhead') {
                // Overhead: hide both life and material fields
                document.getElementById('rm_life_div').classList.add('hidden'); 
                document.getElementById('rm_mat_div').classList.add('hidden'); 
            } else { 
                // material or consumable
                document.getElementById('rm_life_div').classList.add('hidden'); 
                document.getElementById('rm_mat_div').classList.remove('hidden'); 
            } 
        }
        
        function saveRateItem() { 
            let name = document.getElementById('rm_name').value.trim(); 
            let cost = parseFloat(document.getElementById('rm_cost').value);
            let bomId = document.getElementById('rm_bomId').value.trim();
            
            // Validation: Name required
            if (!name) { 
                alert('Please enter an item name.'); 
                return; 
            }
            
            // Validation: BOM ID required
            if (!bomId) {
                alert('BOM ID is required.\n\nEvery Rate Card entry must be linked to a BOM item.');
                return;
            }
            
            // Get the target bucket
            const bucket = currentModalType === 'machine' ? 'machines' 
                         : currentModalType === 'material' ? 'materials'
                         : currentModalType === 'consumable' ? 'consumables'
                         : currentModalType === 'overhead' ? 'overhead' : null;
            
            if (!bucket) {
                alert('Invalid rate type.');
                return;
            }
            
            // Check for existing entry with same BOM ID in this bucket
            if (Array.isArray(rateCard[bucket])) {
                const existing = rateCard[bucket].find(r => String(r.bomId || '').trim() === bomId);
                if (existing) {
                    alert('A Rate Card entry already exists for BOM ID "' + bomId + '" in this bucket.\n\nEdit the existing entry instead of adding another.');
                    return;
                }
            }
            
            if (currentModalType === 'machine') { 
                rateCard.machines.push({ 
                    name: name, 
                    cost: cost, 
                    life: parseFloat(document.getElementById('rm_life').value) || 5,
                    bomId: bomId,
                    minutesPerUnit: 0  // Initialize usage to 0
                }); 
            } else if (currentModalType === 'material') { 
                rateCard.materials.push({ 
                    name: name, 
                    bulk_cost: cost, 
                    qty: parseFloat(document.getElementById('rm_qty').value) || 1, 
                    yield: parseFloat(document.getElementById('rm_yield').value) || 100,
                    bomId: bomId,
                    unitsPerUnit: 0  // Initialize usage to 0
                }); 
            } else if (currentModalType === 'consumable') {
                rateCard.consumables.push({
                    name: name,
                    bulk_cost: cost,
                    qty: parseFloat(document.getElementById('rm_qty').value) || 1,
                    yield: parseFloat(document.getElementById('rm_yield').value) || 100,
                    bomId: bomId,
                    unitsPerUnit: 0  // Initialize usage to 0
                });
            } else if (currentModalType === 'overhead') {
                rateCard.overhead.push({
                    name: name,
                    periodCost: cost,
                    periodType: 'monthly',
                    bomId: bomId,
                    poolId: 'POOL-GEN'  // default pool
                });
            }
            
            try { localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard)); } catch(e) {}
            closeRateModal(); 
            renderRateTables(); 
            updateSim(); 
            
            // Show appropriate confirmation message
            if (currentModalType === 'overhead') {
                alert('Added to Overhead Rate Card! Cost will be spread across monthly volume.');
            } else {
                alert('Added to Rate Card! Set the Usage value to include in COGS.');
            }
        }
        
        function closeRateModal() { document.getElementById('rate-modal').classList.add('hidden'); }
        
        function renderRateTables() { 
            const hoursPerYear = 624;
            
            // Get current volume for overhead per-unit calculation
            const vol = parseFloat(document.getElementById('vol_slider').value) || 0;
            
            // Ensure arrays exist
            if (!Array.isArray(rateCard.machines)) rateCard.machines = [];
            if (!Array.isArray(rateCard.materials)) rateCard.materials = [];
            if (!Array.isArray(rateCard.consumables)) rateCard.consumables = [];
            if (!Array.isArray(rateCard.overhead)) rateCard.overhead = [];
            
            // Equipment Rental Rates
            document.getElementById('table-machines').innerHTML = rateCard.machines.map(function(m, i) {
                const totalCapacity = m.life * hoursPerYear;
                const hourlyRate = totalCapacity > 0 ? (m.cost / totalCapacity) : 0;
                const usage = parseFloat(m.minutesPerUnit) || 0;
                return '<tr><td>' + m.name + '</td><td class="font-mono text-xs">' + (m.bomId || '') + '</td><td class="text-right text-blue-600">$' + hourlyRate.toFixed(2) + '</td><td>' + m.life + '</td><td class="text-right font-mono">' + totalCapacity.toFixed(0) + '</td><td class="text-center bg-blue-50"><input type="number" step="0.1" min="0" class="w-20 text-center border rounded px-1 py-0.5 text-sm" value="' + usage + '" onchange="updateRateUsage(\'machines\', ' + i + ', \'minutesPerUnit\', this.value)"></td><td class="text-center"><button type="button" class="cursor-pointer text-red-400 hover:text-red-600 text-lg font-bold px-2" onclick="deleteRate(\'machines\', ' + i + ')">√ó</button></td></tr>';
            }).join(''); 
            
            // Material Unit Rates
            document.getElementById('table-materials').innerHTML = rateCard.materials.map(function(m, i) {
                const effectiveQty = m.qty * ((m.yield || 100) / 100);
                const unitRate = effectiveQty > 0 ? (m.bulk_cost / effectiveQty) : 0;
                const usage = parseFloat(m.unitsPerUnit) || 0;
                return '<tr><td>' + m.name + '</td><td class="font-mono text-xs">' + (m.bomId || '') + '</td><td class="text-right text-green-600">$' + unitRate.toFixed(3) + '</td><td>$' + m.bulk_cost + '</td><td>' + m.qty + '</td><td class="text-center bg-green-50"><input type="number" step="0.01" min="0" class="w-20 text-center border rounded px-1 py-0.5 text-sm" value="' + usage + '" onchange="updateRateUsage(\'materials\', ' + i + ', \'unitsPerUnit\', this.value)"></td><td class="text-center"><button type="button" class="cursor-pointer text-red-400 hover:text-red-600 text-lg font-bold px-2" onclick="deleteRate(\'materials\', ' + i + ')">√ó</button></td></tr>';
            }).join(''); 
            
            // Consumable Unit Rates
            document.getElementById('table-consumables').innerHTML = rateCard.consumables.map(function(m, i) {
                const effectiveQty = m.qty * ((m.yield || 100) / 100);
                const unitRate = effectiveQty > 0 ? (m.bulk_cost / effectiveQty) : 0;
                const usage = parseFloat(m.unitsPerUnit) || 0;
                return '<tr><td>' + m.name + '</td><td class="font-mono text-xs">' + (m.bomId || '') + '</td><td class="text-right text-orange-600">$' + unitRate.toFixed(3) + '</td><td>$' + m.bulk_cost + '</td><td>' + m.qty + '</td><td class="text-center bg-orange-50"><input type="number" step="0.01" min="0" class="w-20 text-center border rounded px-1 py-0.5 text-sm" value="' + usage + '" onchange="updateRateUsage(\'consumables\', ' + i + ', \'unitsPerUnit\', this.value)"></td><td class="text-center"><button type="button" class="cursor-pointer text-red-400 hover:text-red-600 text-lg font-bold px-2" onclick="deleteRate(\'consumables\', ' + i + ')">√ó</button></td></tr>';
            }).join('');
            
            // Overhead Rates
            document.getElementById('table-overhead').innerHTML = rateCard.overhead.map(function(o, i) {
                const periodCost = parseFloat(o.periodCost) || 0;
                const perUnit = (vol > 0) ? (periodCost / vol) : 0;
                
                // Resolve pool (fallback to POOL-GEN for backward compatibility)
                const poolId = o.poolId || 'POOL-GEN';
                const pool = OVERHEAD_POOLS.find(function(p) { return p.id === poolId; });
                
                // Build pool <select>
                const poolSelect = '<select class="text-xs border rounded px-1 py-0.5 bg-white" ' +
                    'onchange="updateOverheadPool(' + i + ', this.value)">' +
                    OVERHEAD_POOLS.map(function(p) {
                        const selected = p.id === poolId ? ' selected' : '';
                        return '<option value="' + p.id + '"' + selected + '>' + p.label + '</option>';
                    }).join('') +
                    '</select>';
                
                return '<tr>' +
                    '<td>' + o.name + '</td>' +
                    '<td class="font-mono text-xs">' + (o.bomId || '') + '</td>' +
                    '<td>' + poolSelect + '</td>' +
                    '<td class="text-right">$' + periodCost.toFixed(2) + '</td>' +
                    '<td class="text-right bg-gray-100 text-gray-600">$' + perUnit.toFixed(3) + '</td>' +
                    '<td class="text-center">' +
                        '<button type="button" class="cursor-pointer text-red-400 hover:text-red-600 text-lg font-bold px-2" onclick="deleteRate(\'overhead\', ' + i + ')">√ó</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
            
            // Render Overhead Pools summary
            renderOverheadPools();
        }
        
        // Update overhead item's pool assignment
        function updateOverheadPool(idx, poolId) {
            if (!Array.isArray(rateCard.overhead) || !rateCard.overhead[idx]) return;
            rateCard.overhead[idx].poolId = poolId;

            try {
                localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard));
            } catch (e) {}

            // Re-render to keep everything in sync
            renderRateTables();
            updateSim();
        }
        
        // Render Overhead Pools summary table
        function renderOverheadPools() {
            const tbody = document.getElementById('overhead-pools-body');
            if (!tbody) return;

            const vol = parseFloat(document.getElementById('vol_slider').value) || 0;

            // Aggregate monthly cost per pool from rateCard.overhead
            const poolTotals = {};
            (rateCard.overhead || []).forEach(function(o) {
                const poolId = o.poolId || 'POOL-GEN';
                const periodCost = parseFloat(o.periodCost) || 0;
                if (!poolTotals[poolId]) poolTotals[poolId] = 0;
                poolTotals[poolId] += periodCost;
            });

            const rows = OVERHEAD_POOLS.map(function(pool, idx) {
                const monthly = poolTotals[pool.id] || 0;
                const perUnit = vol > 0 ? (monthly / vol) : 0;

                const checked = pool.isActive ? 'checked' : '';
                const toggleHtml = '<input type="checkbox" class="accent-blue-600" ' +
                    'onchange="toggleOverheadPoolActive(' + idx + ', this.checked)" ' + checked + '>';

                return '<tr>' +
                    '<td class="font-bold text-gray-800">' + pool.label + '</td>' +
                    '<td class="text-gray-500">' + (pool.desc || '') + '</td>' +
                    '<td class="text-center">' + toggleHtml + '</td>' +
                    '<td class="text-right font-mono">$' + monthly.toFixed(2) + '</td>' +
                    '<td class="text-right font-mono">$' + perUnit.toFixed(3) + '</td>' +
                '</tr>';
            }).join('');

            tbody.innerHTML = rows;
        }
        
        // Toggle overhead pool active state
        function toggleOverheadPoolActive(idx, isActive) {
            if (!OVERHEAD_POOLS[idx]) return;
            OVERHEAD_POOLS[idx].isActive = isActive;
            // Re-render - this affects both pool display and Simulator totals
            updateSim();
            renderOverheadPools();
        }
        
        // Update usage value on a Rate Card entry
        function updateRateUsage(type, idx, field, value) {
            if (!Array.isArray(rateCard[type]) || !rateCard[type][idx]) return;
            
            rateCard[type][idx][field] = parseFloat(value) || 0;
            
            try { localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard)); } catch(e) {}
            updateSim();  // Recompute COGS immediately
        }
        
        // --- RATE CARD DELETE (TASK 1 FIX) ---
        function deleteRate(type, idx) { 
            // Validate type and ensure array exists
            if (!rateCard || !Array.isArray(rateCard[type])) {
                console.error('deleteRate: Invalid type or rateCard not initialized:', type);
                return;
            }
            
            // Validate index
            if (idx < 0 || idx >= rateCard[type].length) {
                console.error('deleteRate: Invalid index:', idx, 'for type:', type, 'array length:', rateCard[type].length);
                return;
            }
            
            const item = rateCard[type][idx];
            const itemName = item && item.name ? item.name : 'this entry';
            
            // Confirm deletion with proper string concatenation (no template literals)
            const confirmMessage = 'Delete "' + itemName + '"? This will remove its cost from the simulator.';
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Remove the item
            rateCard[type].splice(idx, 1);
            
            // Persist to localStorage
            try { 
                localStorage.setItem('isaacs_rates_v8', JSON.stringify(rateCard)); 
            } catch(e) {
                console.log('Could not save to localStorage:', e);
            }
            
            // Re-render tables and update simulation
            renderRateTables(); 
            updateSim(); 
        }
        
        function populateRulesTab() { 
            const tbody = document.getElementById('rules-table-body'); 
            let html = ''; 
            FUNCTIONAL_ARCHITECTURE.forEach(function(func, idx) { 
                html += '<tr class="bg-white border-b">' +
                    '<td class="py-3 px-4 font-bold text-blue-800 align-top">' + func.id + '</td>' +
                    // Function Name (editable -> func.name)
                    '<td class="py-3 px-4 text-sm font-bold text-gray-700 align-top">' +
                        '<textarea class="editable-cell h-10" onchange="FUNCTIONAL_ARCHITECTURE[' + idx + '].name=this.value; renderJobAidFromRules();">' +
                            (func.name || '') +
                        '</textarea>' +
                    '</td>' +
                    // Key Rule (editable -> func.ruleLabel)
                    '<td class="py-3 px-4 align-top">' +
                        '<textarea class="editable-cell h-16" onchange="FUNCTIONAL_ARCHITECTURE[' + idx + '].ruleLabel=this.value; renderJobAidFromRules();">' +
                            (func.ruleLabel || '') +
                        '</textarea>' +
                    '</td>' +
                    // Keywords (unchanged)
                    '<td class="py-3 px-4 align-top">' +
                        '<textarea class="editable-cell h-16 font-mono text-xs" onchange="FUNCTIONAL_ARCHITECTURE[' + idx + '].keywords=this.value">' +
                            (func.keywords || '') +
                        '</textarea>' +
                    '</td>' +
                '</tr>'; 
            }); 
            tbody.innerHTML = html; 
        }
        
        // --- COGS COMPUTATION FROM RATE CARD + ALLOCATIONS ---
        function computeCostFromRateCard(rateCard, inventory, vol) {
            let materialsCost = 0;
            let consumablesCost = 0;
            let machineCost = 0;
            let overheadCost = 0;
            
            let functionCost = {};
            FUNCTIONAL_ARCHITECTURE.forEach(function(f) { functionCost[f.id] = 0; });
            
            // Helper: allocate cost to functions based on item.rules
            function allocateToFunctions(bomId, costPerUnit) {
                const items = inventory.filter(function(i) {
                    return String(i.bomId) === String(bomId) &&
                        Array.isArray(i.rules) &&
                        i.rules.length > 0;
                });
                if (!items.length || costPerUnit <= 0) return;
                
                const funcSet = new Set();
                items.forEach(function(i) { i.rules.forEach(function(r) { funcSet.add(r); }); });
                
                const funcs = Array.from(funcSet);
                if (!funcs.length) return;
                
                const share = costPerUnit / funcs.length;
                funcs.forEach(function(fId) {
                    if (functionCost[fId] == null) functionCost[fId] = 0;
                    functionCost[fId] += share;
                });
            }
            
            const hoursPerYear = 624;
            
            // Materials - usage is now on the Rate Card row
            (rateCard.materials || []).forEach(function(m) {
                const effectiveQty = m.qty * ((m.yield || 100) / 100);
                if (!effectiveQty) return;
                const unitRate = m.bulk_cost / effectiveQty;
                
                const usage = parseFloat(m.unitsPerUnit) || 0;
                const costPerUnit = unitRate * usage;
                materialsCost += costPerUnit;
                allocateToFunctions(m.bomId, costPerUnit);
            });
            
            // Consumables - usage is now on the Rate Card row
            (rateCard.consumables || []).forEach(function(m) {
                const effectiveQty = m.qty * ((m.yield || 100) / 100);
                if (!effectiveQty) return;
                const unitRate = m.bulk_cost / effectiveQty;
                
                const usage = parseFloat(m.unitsPerUnit) || 0;
                const costPerUnit = unitRate * usage;
                consumablesCost += costPerUnit;
                allocateToFunctions(m.bomId, costPerUnit);
            });
            
            // Machines - usage (minutesPerUnit) is now on the Rate Card row
            (rateCard.machines || []).forEach(function(m) {
                const totalCapacity = m.life * hoursPerYear;
                if (!totalCapacity) return;
                const hourlyRate = m.cost / totalCapacity;
                
                const minutesPerUnit = parseFloat(m.minutesPerUnit) || 0;
                const costPerUnit = hourlyRate * (minutesPerUnit / 60);
                machineCost += costPerUnit;
                allocateToFunctions(m.bomId, costPerUnit);
            });
            
            // Overhead - period cost spread across monthly volume
            // Respect pool.isActive - inactive pools don't contribute to overhead or function cost
            (rateCard.overhead || []).forEach(function(o) {
                const periodCost = parseFloat(o.periodCost) || 0;
                // Avoid division by zero; if vol is 0 or NaN, overhead per unit is 0
                const costPerUnit = (vol > 0) ? (periodCost / vol) : 0;
                
                // Check if pool is active
                const poolId = o.poolId || 'POOL-GEN';
                const pool = OVERHEAD_POOLS.find(function(p) { return p.id === poolId; });
                const isActive = !pool || pool.isActive; // if pool missing, treat as active
                
                if (!isActive) {
                    // Inactive pools do not contribute to overheadCost or functionCost
                    return;
                }
                
                overheadCost += costPerUnit;
                allocateToFunctions(o.bomId, costPerUnit);
            });
            
            return { materialsCost: materialsCost, consumablesCost: consumablesCost, machineCost: machineCost, overheadCost: overheadCost, functionCost: functionCost };
        }
        
        function updateSim() { 
            // Get volume first (needed for overhead calculation)
            let vol = parseFloat(document.getElementById('vol_slider').value) || 0;
            
            // Compute costs from Rate Card (usage is now stored on Rate Card rows)
            const result = computeCostFromRateCard(rateCard, inventory, vol);
            const materialsCost = result.materialsCost;
            const consumablesCost = result.consumablesCost;
            const machineCost = result.machineCost;
            const overheadCost = result.overheadCost;
            const functionCost = result.functionCost;
            
            const mat_cost_base = materialsCost + consumablesCost;
            
            let labor_rate = parseFloat(document.getElementById('labor_rate_slider').value); 
            let time_min = parseFloat(document.getElementById('time_slider').value); 
            let msrp = parseFloat(document.getElementById('msrp_input').value); 
            
            // Update display labels
            document.getElementById('labor_val').innerText = '$' + labor_rate + '/hr';
            document.getElementById('time_val').innerText = time_min + ' min';
            document.getElementById('vol_val').innerText = vol + ' Units';
            
            let labor_cost = (time_min / 60) * labor_rate; 
            let total = mat_cost_base + labor_cost + machineCost + overheadCost; 
            let margin = msrp > 0 ? ((msrp - total) / msrp) * 100 : 0; 
            
            document.getElementById('total_cogs').innerText = '$' + total.toFixed(2); 
            document.getElementById('margin_val').innerText = margin.toFixed(1) + '%'; 
            
            let mc = document.getElementById('margin_card'); 
            if(margin >= 40) { 
                mc.className = "card bg-green-50 border border-green-200"; 
                document.getElementById('margin_status').innerText="Healthy"; 
                document.getElementById('margin_status').className = "text-xs font-bold mt-1 text-green-600";
            } else { 
                mc.className = "card bg-red-50 border border-red-200"; 
                document.getElementById('margin_status').innerText="Low"; 
                document.getElementById('margin_status').className = "text-xs font-bold mt-1 text-red-600";
            } 
            
            document.getElementById('cost_breakdown_list').innerHTML = '<li class="flex justify-between"><span>Materials + Consumables</span><span class="font-mono">$' + mat_cost_base.toFixed(2) + '</span></li><li class="flex justify-between"><span>Labor</span><span class="font-mono">$' + labor_cost.toFixed(2) + '</span></li><li class="flex justify-between"><span>Machine</span><span class="font-mono">$' + machineCost.toFixed(2) + '</span></li><li class="flex justify-between"><span>Overhead</span><span class="font-mono">$' + overheadCost.toFixed(2) + '</span></li>'; 
            
            // Render Overhead by Pool breakdown in Simulator
            renderOverheadPoolBreakdown(vol);
            
            if(chartInstance) { 
                chartInstance.data.datasets[0].data = [mat_cost_base, labor_cost, machineCost, overheadCost]; 
                chartInstance.update(); 
            }
            
            renderFunctionCostTable(functionCost);
        }
        
        // Render overhead breakdown by pool in Simulator sidebar
        function renderOverheadPoolBreakdown(vol) {
            const list = document.getElementById('overhead_pool_breakdown_list');
            if (!list) return;

            const poolTotalsPerUnit = {};
            (rateCard.overhead || []).forEach(function(o) {
                const poolId = o.poolId || 'POOL-GEN';
                const pool = OVERHEAD_POOLS.find(function(p) { return p.id === poolId; });
                const isActive = !pool || pool.isActive;

                if (!isActive) return;

                const periodCost = parseFloat(o.periodCost) || 0;
                const perUnit = vol > 0 ? (periodCost / vol) : 0;

                if (!poolTotalsPerUnit[poolId]) poolTotalsPerUnit[poolId] = 0;
                poolTotalsPerUnit[poolId] += perUnit;
            });

            const items = OVERHEAD_POOLS.map(function(pool) {
                const perUnit = poolTotalsPerUnit[pool.id] || 0;
                if (!pool.isActive && perUnit === 0) return '';
                const labelClass = pool.isActive ? 'text-gray-500' : 'text-gray-400 line-through';
                return '<li class="flex justify-between">' +
                    '<span class="' + labelClass + '">' + pool.label + (pool.isActive ? '' : ' (off)') + '</span>' +
                    '<span class="font-mono">$' + perUnit.toFixed(2) + '</span>' +
                '</li>';
            }).filter(Boolean).join('');

            list.innerHTML = items || '<li class="text-gray-400">No active overhead pools.</li>';
        }
        
        function renderFunctionCostTable(functionCost) {
            const tbody = document.getElementById('function-cost-body');
            if (!tbody) return;
            
            let rows = '';
            
            FUNCTIONAL_ARCHITECTURE.forEach(function(func) {
                const cost = functionCost[func.id] || 0;
                
                // Find contributing BOM IDs
                const bomSet = new Set();
                inventory.forEach(function(item) {
                    if (Array.isArray(item.rules) && item.rules.includes(func.id) && item.bomId) {
                        // Check if this BOM ID is in Rate Card (any type including overhead)
                        const inMaterials = (rateCard.materials || []).some(function(m) { return String(m.bomId) === String(item.bomId); });
                        const inConsumables = (rateCard.consumables || []).some(function(m) { return String(m.bomId) === String(item.bomId); });
                        const inMachines = (rateCard.machines || []).some(function(m) { return String(m.bomId) === String(item.bomId); });
                        const inOverhead = (rateCard.overhead || []).some(function(o) { return String(o.bomId) === String(item.bomId); });
                        if (inMaterials || inConsumables || inMachines || inOverhead) {
                            bomSet.add(String(item.bomId));
                        }
                    }
                });
                
                // Only show rows with cost or contributing BOMs
                if (cost > 0 || bomSet.size > 0) {
                    rows += '<tr><td class="font-mono text-xs font-bold text-blue-600">' + func.id + '</td><td class="text-xs">' + func.name + '</td><td class="text-right font-mono ' + (cost > 0 ? 'text-green-600' : 'text-gray-400') + '">$' + cost.toFixed(2) + '</td><td class="text-xs text-gray-500">' + (Array.from(bomSet).join(', ') || '-') + '</td></tr>';
                }
            });
            
            tbody.innerHTML = rows || '<tr><td colspan="4" class="text-center text-xs text-gray-400 py-4">No function-level cost yet. Add items to Rate Card with BOM IDs, set their Usage values, and allocate them to functions.</td></tr>';
        }
        
        function initChart() { 
            const ctx = document.getElementById('costChart').getContext('2d'); 
            chartInstance = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Mat + Cons', 'Labor', 'Machine', 'Overhead'], 
                    datasets: [{ 
                        data: [0,0,0,0], 
                        backgroundColor: ['#10b981','#3b82f6','#f59e0b','#6b7280'] 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                } 
            }); 
        }
        
        function switchTab(tab) { 
            ['sim','mgr','matrix','rates','rules','jobaid','batch'].forEach(function(t) { 
                document.getElementById('view-' + t).classList.add('hidden'); 
                document.getElementById('tab-' + t).classList.remove('active','bg-white','text-blue-700','shadow-sm'); 
            }); 
            document.getElementById('view-' + tab).classList.remove('hidden'); 
            document.getElementById('tab-' + tab).classList.add('active','bg-white','text-blue-700','shadow-sm'); 
            if(tab === 'mgr') renderBoard();
            if(tab === 'matrix') renderMatrixView();
            if(tab === 'sim') updateSim();
            if(tab === 'batch') renderFunctionDataView();
        }
        
        function renderMatrixView() {
            const headRow = document.getElementById('matrix-head-row');
            const tbody = document.getElementById('matrix-body');
            const emptyMsg = document.getElementById('matrix-empty');
            const countEl = document.getElementById('matrix-count');

            // Build header row: BOM ID (w-20) + Part Name (w-64, left-20) frozen, then F0-F10 scrollable
            let headHtml = '<th class="sticky left-0 z-10 bg-gray-50 w-20 min-w-[80px]">BOM ID</th><th class="sticky left-20 z-10 bg-gray-50 w-64 min-w-[256px]">Part Name</th>';
            FUNCTIONAL_ARCHITECTURE.forEach(function(func) {
                const label = func.ruleLabel || func.desc || func.name;
                headHtml += '<th class="text-xs align-bottom min-w-[80px]"><div class="font-bold text-blue-600">' + func.id + '</div><div class="text-[9px] text-gray-400 font-normal leading-tight">' + label + '</div></th>';
            });
            headRow.innerHTML = headHtml;

            // Rows: only items that have at least one rule appended
            const items = inventory.filter(function(i) { return Array.isArray(i.rules) && i.rules.length > 0; });
            
            // Update count
            countEl.innerText = items.length;

            // Show/hide empty message
            if (items.length === 0) {
                emptyMsg.classList.remove('hidden');
                tbody.innerHTML = '';
                return;
            } else {
                emptyMsg.classList.add('hidden');
            }

            let bodyHtml = items.map(function(item) {
                // BOM ID and Part Name with matching widths and sticky positions
                const baseCells = '<td class="sticky left-0 bg-white w-20 min-w-[80px] font-mono text-xs">' + item.bomId + '</td><td class="sticky left-20 bg-white w-64 min-w-[256px] text-sm">' + item.name + '</td>';

                // Clickable rule cells for per-item toggle
                const ruleCells = FUNCTIONAL_ARCHITECTURE.map(function(func) {
                    const hasRule = item.rules && item.rules.includes(func.id);
                    return '<td class="text-center cursor-pointer hover:bg-gray-100 ' + (hasRule ? 'bg-green-50' : '') + '" onclick="toggleRuleForItem(' + JSON.stringify(item.id) + ', \'' + func.id + '\')">' + (hasRule ? '<span class="text-green-600 font-bold">‚úï</span>' : '') + '</td>';
                }).join('');

                return '<tr class="hover:bg-gray-50">' + baseCells + ruleCells + '</tr>';
            }).join('');

            tbody.innerHTML = bodyHtml;
        }
        
        // Toggle a specific rule for a specific item (per-item add/remove)
        function toggleRuleForItem(itemId, fId) {
            const item = inventory.find(function(i) { return i.id == itemId; });
            if (!item) return;
            if (!Array.isArray(item.rules)) item.rules = [];
            
            const idx = item.rules.indexOf(fId);
            if (idx >= 0) {
                item.rules.splice(idx, 1);    // un-append for this one item
            } else {
                item.rules.push(fId);         // append for this one item
            }
            
            renderBoard();
            renderMatrixView();
            updateSim();  // Recompute COGS & function costs
        }
        
        // --- MATRIX CSV EXPORT/IMPORT ---
        function escapeCSV(value) {
            const v = (value == null ? '' : String(value));
            return /[",\n]/.test(v) ? '"' + v.replace(/"/g, '""') + '"' : v;
        }
        
        function exportMatrixCSV() {
            const items = inventory.filter(function(i) { return Array.isArray(i.rules) && i.rules.length > 0; });
            if (items.length === 0) {
                alert('No items with rules to export.');
                return;
            }
            
            const headers = ['BOM ID', 'Part Name'].concat(FUNCTIONAL_ARCHITECTURE.map(function(f) { return f.id; }));
            
            const rows = items.map(function(item) {
                const base = [item.bomId, item.name];
                const flags = FUNCTIONAL_ARCHITECTURE.map(function(func) {
                    return item.rules.includes(func.id) ? 'X' : '';
                });
                return base.concat(flags);
            });

            const csvLines = [headers.join(',')].concat(rows.map(function(r) { return r.map(escapeCSV).join(','); }));
            
            const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'allocation_matrix.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importMatrixAllocations(rows) {
            let updated = 0;
            rows.forEach(function(row) {
                const bomId = String(row['BOM ID'] || '').trim();
                if (!bomId) return;
                const item = inventory.find(function(i) { return String(i.bomId).trim() === bomId; });
                if (!item) return;

                const newRules = [];
                FUNCTIONAL_ARCHITECTURE.forEach(function(func) {
                    const colVal = row[func.id];
                    // Accept 'X', 'x', '1', or any non-empty value as "rule applied"
                    if (colVal && String(colVal).trim() !== '') {
                        newRules.push(func.id);
                    }
                });
                item.rules = newRules;
                updated++;
            });

            renderBoard();
            renderMatrixView();
            updateSim();
            alert('Matrix allocations imported.\nUpdated ' + updated + ' item(s).');
        }
        
        function setupMatrixUpload() {
            const mu = document.getElementById('matrix_upload');
            if (mu) {
                mu.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(r) { importMatrixAllocations(r.data); }
                    });
                    // Reset file input so same file can be re-imported
                    e.target.value = '';
                });
            }
        }
        
        // Sync Job Aid "Key Rule" text from FUNCTIONAL_ARCHITECTURE (single source of truth)
        function renderJobAidFromRules() {
            FUNCTIONAL_ARCHITECTURE.forEach(function(func) {
                const el = document.getElementById('keyrule-' + func.id);
                if (el && func.ruleLabel) {
                    el.textContent = func.ruleLabel;
                }
                // Also update the decision tree questions
                const dtEl = document.getElementById('dt-' + func.id);
                if (dtEl && func.ruleLabel) {
                    dtEl.textContent = '"' + func.ruleLabel + '?"';
                }
            });
        }
        
        // --- MANUAL ADD WITH BOM ID UNIQUENESS (TASK 2) ---
        function addNewItem() { 
            let name = document.getElementById('new_name').value.trim();
            if(!name) {
                alert('Please enter an item name.');
                return;
            }
            
            let bomIdInput = document.getElementById('new_bomId').value.trim();
            let bomId;
            
            if (bomIdInput) {
                // User provided a BOM ID - check for uniqueness
                if (bomIdExists(bomIdInput)) {
                    alert('BOM ID "' + bomIdInput + '" already exists in inventory.\n\nPlease use a different BOM ID or leave blank to auto-generate.');
                    return;
                }
                bomId = bomIdInput;
            } else {
                // No BOM ID provided - generate unique MAN-### ID
                bomId = generateUniqueBomId();
            }
            
            inventory.push({
                id: Date.now(), 
                bomId: bomId, 
                name: name, 
                cost: parseFloat(document.getElementById('new_cost').value) || 0, 
                desc: '',
                type: 'Overhead', 
                visualType: 'Overhead', 
                func: 'Unallocated',
                allocatedTo: '',
                rules: []
            }); 
            
            // Clear inputs
            document.getElementById('new_bomId').value = '';
            document.getElementById('new_name').value = '';
            document.getElementById('new_cost').value = '';
            
            renderBoard();
            checkForDuplicateBomIds(); // Run integrity check
        }
    </script>
</body>
</html>
